<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AkÄ±llÄ± CV Platformu Â· Tek Dosya</title>
  <style>
    :root{
      --bg:#0b1220;
      --bg2:#0f172a;
      --panel:#0b1220;
      --card:#0f172a;
      --paper:#ffffff;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:rgba(255,255,255,0.10);
      --accent:#60a5fa;
      --accent2:#22c55e;
      --danger:#ef4444;
      --shadow: 0 22px 50px rgba(0,0,0,.35);
      --radius: 14px;
      --font: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    html[data-theme="light"]{
      --bg:#f3f4f6;
      --bg2:#ffffff;
      --panel:#ffffff;
      --card:#ffffff;
      --paper:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:rgba(15,23,42,0.12);
      --accent:#2563eb;
      --accent2:#16a34a;
      --shadow: 0 18px 38px rgba(15,23,42,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:var(--font); background:linear-gradient(160deg,var(--bg),var(--bg2)); color:var(--text);}
    a{color:inherit}
    button,input,select,textarea{font-family:inherit}
    /* Shell */
    .shell{min-height:100%; display:flex; flex-direction:column}
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px; border-bottom:1px solid var(--border);
      background:rgba(10,16,30,.78); backdrop-filter: blur(10px);
    }
    html[data-theme="light"] .topbar{background:rgba(255,255,255,.78)}
    .brand{display:flex; align-items:center; gap:10px; min-width:0}
    .logo{
      width:34px; height:34px; border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#a78bfa);
      box-shadow: 0 10px 26px rgba(96,165,250,.25);
      display:grid; place-items:center; font-weight:800;
    }
    .brand .title{line-height:1.1; min-width:0}
    .brand .title b{display:block; font-size:13px; letter-spacing:.02em}
    .brand .title span{display:block; font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:58vw}
    .top-actions{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    html[data-theme="light"] .btn:hover{background:rgba(15,23,42,.06)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#8b5cf6); border-color:transparent}
    .btn.primary:hover{filter:brightness(1.02)}
    .btn.good{background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.35)}
    .btn.danger{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35)}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 10px; border-radius:999px; border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      font-size:12px; color:var(--muted);
    }
    html[data-theme="light"] .pill{background:rgba(15,23,42,.03)}
    .seg{
      display:inline-flex; border:1px solid var(--border); border-radius:999px; overflow:hidden;
    }
    .seg button{
      border:0; background:transparent; color:var(--muted);
      padding:7px 10px; font-size:12px; cursor:pointer;
    }
    .seg button.active{background:rgba(255,255,255,.08); color:var(--text); font-weight:700}
    html[data-theme="light"] .seg button.active{background:rgba(15,23,42,.08)}
    /* Layout */
    .main{flex:1; display:grid; grid-template-columns: 1fr; gap:12px; padding:12px; max-width:1400px; margin:0 auto; width:100%}
    @media(min-width:1100px){
      .main{grid-template-columns: 420px 1fr}
    }
    /* Left panel */
    .panel-wrap{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:420px;
    }
    html[data-theme="light"] .panel-wrap{background:rgba(255,255,255,.7)}
    .panel-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
    }
    .panel-head b{font-size:12px; letter-spacing:.12em; text-transform:uppercase}
    .panel-tabs{
      display:flex; flex-wrap:wrap; gap:6px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    .tab{
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:transparent; color:var(--text);
      font-size:12px; cursor:pointer;
    }
    .tab.active{background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.20); font-weight:700}
    html[data-theme="light"] .tab.active{background:rgba(15,23,42,.08); border-color:rgba(15,23,42,.18)}
    .panel-body{padding:12px; max-height:calc(100vh - 160px); overflow:auto}
    .section{display:none}
    .section.active{display:block}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media(max-width:520px){ .grid2{grid-template-columns:1fr} }
    .field{margin-bottom:10px}
    .field label{display:block; font-size:11px; color:var(--muted); margin-bottom:4px}
    .field input,.field select,.field textarea{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 10px;
      font-size:13px;
      outline:none;
    }
    html[data-theme="light"] .field input, html[data-theme="light"] .field select, html[data-theme="light"] .field textarea{
      background:#fff;
    }
    .field textarea{min-height:86px; resize:vertical}
    .hint{font-size:11px; color:var(--muted); margin-top:4px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .mini-btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
    }
    html[data-theme="light"] .mini-btn{background:#fff}
    .mini-btn:hover{background:rgba(255,255,255,.08)}
    .hr{height:1px; background:var(--border); margin:12px 0}
    .cardbox{
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(255,255,255,.03);
      padding:10px;
      margin-bottom:10px;
    }
    html[data-theme="light"] .cardbox{background:rgba(15,23,42,.03)}
    .cardbox-head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
    .cardbox-head b{font-size:12px}
    .tiny{font-size:11px; color:var(--muted)}
    /* Preview */
    .preview-wrap{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:520px;
    }
    html[data-theme="light"] .preview-wrap{background:rgba(255,255,255,.7)}
    .preview-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
    }
    .preview-head .left{display:flex; align-items:center; gap:10px; min-width:0}
    .preview-head .left b{font-size:12px; letter-spacing:.12em; text-transform:uppercase}
    .preview-head .left span{font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:52vw}
    .preview-body{
      padding:12px;
      overflow:auto; 
      flex:1;
    }
    /* A4 paper */
    .paper{
      width: 210mm;
      max-width: 100%;
      margin:0 auto;
      background:var(--paper);
      color:#0f172a;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      box-shadow: 0 18px 44px rgba(0,0,0,.15);
      padding:18px;
    }
    .paper *{color:#0f172a}
    .cv-topbar{
      display:flex; justify-content:space-between; gap:14px; align-items:flex-start;
      border-bottom:1px solid rgba(15,23,42,.10);
      padding-bottom:10px; margin-bottom:12px;
    }
    .contact-lines{font-size:11px; color:#4b5563}
    .contact-lines div{margin:2px 0; display:flex; flex-wrap:wrap; gap:10px}
    .contact-lines span{display:inline-flex; gap:6px; align-items:center}
    .qrbox{
      width:64px; height:64px; border-radius:10px;
      border:1px dashed rgba(15,23,42,.35);
      display:grid; place-items:center;
      overflow:hidden;
      background:#fff;
    }
    .qrbox img{width:100%; height:100%; object-fit:cover}
    .qr-cap{font-size:9px; color:#6b7280; max-width:190px; text-align:right; margin-top:4px}
    .profile{
      display:grid; grid-template-columns: 1.4fr 1fr; gap:14px; margin-bottom:12px;
    }
    @media(max-width:900px){ .profile{grid-template-columns:1fr} }
    .cv-card{
      border:1px solid rgba(15,23,42,.10);
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .p-head{display:flex; gap:12px; align-items:center}
    .photo{
      width:78px; height:104px; border-radius:14px;
      background:#0f172a;
      color:#fff;
      display:grid; place-items:center;
      font-weight:900;
      overflow:hidden;
      box-shadow: 0 12px 24px rgba(15,23,42,.12);
    }
    .photo img{width:100%; height:100%; object-fit:cover}
    .name{font-size:18px; font-weight:800; letter-spacing:.01em}
    .role{font-size:12px; color:#6b7280; margin-top:2px}
    .chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:10px}
    .chip{
      border:1px solid rgba(15,23,42,.10);
      border-radius:999px;
      padding:3px 8px;
      font-size:10px;
      background:#f9fafb;
      color:#111827;
      white-space:nowrap;
    }
    .highlight{
      margin-top:10px;
      display:flex; gap:8px; align-items:flex-start;
      border:1px solid rgba(34,197,94,.28);
      background:#ecfdf5;
      color:#065f46;
      border-radius:999px;
      padding:6px 10px;
      font-size:11px;
    }
    .mini-grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px}
    @media(max-width:560px){ .mini-grid{grid-template-columns:1fr} }
    .mini-title{
      font-size:10px; color:#6b7280; text-transform:uppercase; letter-spacing:.12em; font-weight:800;
      margin-bottom:5px;
      display:flex; align-items:center; gap:8px;
    }
    .mini-title:before{content:""; width:18px; height:1px; background:var(--accent); border-radius:999px}
    .mini-list{margin:0; padding-left:16px; font-size:11px}
    .mini-list li{margin-bottom:2px}
    .sec-title{
      margin:12px 0 6px;
      font-size:11px; color:#6b7280;
      text-transform:uppercase; letter-spacing:.16em; font-weight:900;
      display:flex; gap:8px; align-items:center;
    }
    .sec-title:before{content:""; width:18px; height:1px; background:var(--accent); border-radius:999px}
    .sec-body{font-size:11px}
    .item{margin-bottom:8px}
    .item b{font-size:11px}
    .meta{font-size:10px; color:#6b7280; margin-top:2px}
    .bul{margin:4px 0 0; padding-left:16px}
    .bul li{margin-bottom:2px}
    .footer{
      border-top:1px solid rgba(15,23,42,.10);
      margin-top:12px; padding-top:10px;
      font-size:10px; color:#6b7280;
    }
    /* Modal A4 */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:200;
    }
    .modal.open{display:flex}
    .modal-box{
      width:min(980px, 96vw);
      max-height:92vh;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(10,16,30,.92);
      backdrop-filter: blur(10px);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex; flex-direction:column;
    }
    html[data-theme="light"] .modal-box{background:rgba(255,255,255,.96)}
    .modal-top{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
    }
    .modal-top b{font-size:12px; letter-spacing:.12em; text-transform:uppercase}
    .modal-body{padding:12px; overflow:auto}
    /* Overlay for panel on mobile */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; z-index:80;
    }
    .overlay.open{display:block}
    @media(min-width:1100px){ .overlay{display:none !important} }
    .drawer{
      position:fixed; top:0; left:0; bottom:0;
      width:min(430px, 92vw);
      background:linear-gradient(180deg, rgba(10,16,30,.98), rgba(10,16,30,.92));
      border-right:1px solid var(--border);
      box-shadow: 16px 0 40px rgba(0,0,0,.35);
      transform: translateX(-105%);
      transition: transform .2s ease;
      z-index:120;
      display:flex; flex-direction:column;
    }
    html[data-theme="light"] .drawer{background:rgba(255,255,255,.98)}
    .drawer.open{transform:translateX(0)}
    .drawer .panel-wrap{border:0; border-radius:0; box-shadow:none; background:transparent; min-height:100%}
    @media(min-width:1100px){
      .drawer{position:static; transform:none !important; width:auto; background:transparent; box-shadow:none; border-right:0; z-index:auto}
      .drawer.open{transform:none}
      .drawer .panel-wrap{border:1px solid var(--border); border-radius:var(--radius); box-shadow: var(--shadow); background:rgba(255,255,255,.03)}
      html[data-theme="light"] .drawer .panel-wrap{background:rgba(255,255,255,.7)}
    }
    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      background:rgba(15,23,42,.92); color:#fff;
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:10px 12px;
      font-size:12px;
      z-index:500;
      display:none;
      max-width:92vw;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
    }
    html[data-theme="light"] .toast{background:rgba(15,23,42,.92)}
    /* Print */
    @media print{
      .topbar, .drawer, .overlay, .preview-head, .modal, .toast {display:none !important}
      body{background:#fff}
      .main{display:block; padding:0}
      .preview-wrap{border:0; border-radius:0; box-shadow:none}
      .preview-body{padding:0}
      .paper{box-shadow:none; border-radius:0; border:0; width:210mm; max-width:210mm; margin:0}
    }
  

/* ==== CareerOS Panel Scroll Fix (iOS Safari / small screens) ==== */
:root{ --safe-bottom: env(safe-area-inset-bottom, 0px); }

.drawer{
  /* keep overlay drawer stable across mobile address bar changes */
  height: 100dvh;
  padding-bottom: var(--safe-bottom);
}

.panel-wrap{
  display: flex;
  flex-direction: column;
  min-height: 0; /* critical: allow children to shrink for scrolling */
}

.panel-head, .panel-tabs{
  flex: 0 0 auto;
}

.panel-body{
  flex: 1 1 auto;
  min-height: 0;
  max-height: none !important;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: calc(var(--safe-bottom) + 88px); /* allow last fields to be reachable */
}

/* If the panel is used as a fixed desktop sidebar too, this prevents 'cut off' there as well */
@media (min-width: 900px){
  .panel-body{ padding-bottom: 32px; }
}
/* ==== End Fix ==== */


/* Share mode: hide left panel, show only preview */
body.share-mode .panel-wrap{display:none !important;}
body.share-mode .preview-wrap{grid-column:1 / -1 !important; width:100% !important; max-width:1200px; margin:0 auto;}
body.share-mode .topbar{position:sticky; top:0; z-index:50;}

/* --- Export dropdown (topbar) --- */
#topbar{ position:sticky; top:0; z-index:40; }
#topbar .btn{ position:relative; }
#exportMenu{
  position:absolute;
  right:12px;
  top:52px;
  min-width:240px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:0 18px 50px rgba(0,0,0,.18);
  padding:10px;
  display:none;
  z-index:60;
}
#exportMenu.open{ display:block; }
#exportMenu .menu-item{
  width:100%;
  text-align:left;
  padding:10px 12px;
  border:0;
  border-radius:12px;
  background:transparent;
  color:var(--text);
  cursor:pointer;
  font-weight:700;
}
#exportMenu .menu-item:hover{ background: rgba(0,0,0,.06); }
body.dark #exportMenu .menu-item:hover{ background: rgba(255,255,255,.08); }
#exportMenu .menu-sep{ height:1px; background:var(--border); margin:8px 0; opacity:.9; }

</style>
</head>
<body>
<div class="shell">
  <div class="topbar">
    <div class="brand">
      <div class="logo">A</div>
      <div class="title">
        <b>AkÄ±llÄ± CV Platformu</b>
        <span id="subTitle">AI destekli kariyer sistemi Â· Tek dosya demo (tam modÃ¼llÃ¼)</span>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn" id="btnOpenPanel">â˜° Panel</button>
      <button class="btn" id="btnA4">ğŸ—‚ A4 Ã–nizleme</button>
      <button class="btn" id="btnPrint">ğŸ–¨ï¸ PDF/YazdÄ±r</button>

<button class="btn" id="btnExportMenu" aria-haspopup="true" aria-expanded="false">â¬‡ï¸ Ä°ndir</button>
<div class="dropdown-menu" id="exportMenu" role="menu" aria-label="DÄ±ÅŸa Aktarma">
  <button class="menu-item" data-export="pdf">PDF (A4)</button>
  <button class="menu-item" data-export="word">Word (.doc)</button>
  <button class="menu-item" data-export="pptx">PPTX (tek slayt)</button>
  <button class="menu-item" data-export="png">PNG</button>
  <button class="menu-item" data-export="jpg">JPG</button>
  <button class="menu-item" data-export="svg">SVG (deneysel)</button>
  <div class="menu-sep"></div>
  <button class="menu-item" data-export="json">Yedek (JSON)</button>
</div>

      <div class="seg" title="Tema">
        <button id="tSystem" class="active" type="button">Sistem</button>
        <button id="tLight" type="button">AÃ§Ä±k</button>
        <button id="tDark" type="button">Koyu</button>
      </div>
      <div class="seg" title="Cihaz">
        <button id="dDesk" class="active" type="button">MasaÃ¼stÃ¼</button>
        <button id="dMob" type="button">Mobil</button>
      </div>
      <button class="btn primary" id="btnAutoPilot">ğŸ¤– Otopilot</button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="main" id="mainGrid">
    <!-- Drawer / Left -->
    <div class="drawer" id="drawer">
      <div class="panel-wrap">
        <div class="panel-head">
          <b>DÃ¼zenleme Paneli</b>
          <div class="row">
            <span class="pill" id="statePill">Kaydedildi</span>
            <button class="btn" id="btnClosePanel" title="Kapat">âœ•</button>
          </div>
        </div>

        <div class="panel-tabs" id="tabs">
          <button class="tab active" data-tab="tabStart">BaÅŸlat</button>
          <button class="tab" data-tab="tabProfile">Profil</button>
          <button class="tab" data-tab="tabContact">Ä°letiÅŸim</button>
          <button class="tab" data-tab="tabSeo">Ã‡erÃ§eve/SEO</button>
          <button class="tab" data-tab="tabCards">Kartlar</button>
          <button class="tab" data-tab="tabEdu">EÄŸitim</button>
          <button class="tab" data-tab="tabExp">Deneyim</button>
          <button class="tab" data-tab="tabCert">Sertifikalar</button>
          <button class="tab" data-tab="tabRefs">Referans</button>
          <button class="tab" data-tab="tabEssay">Essay</button>
          <button class="tab" data-tab="tabAI">AI StÃ¼dyo</button>
          <button class="tab" data-tab="tabFeedback">Geri Bildirim</button>
        </div>

        <div class="panel-body">

          <!-- START / FLOW -->
          <div class="section active" id="tabStart">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>AkÄ±llÄ± AkÄ±ÅŸ</b>
                <span class="tiny">Meslek â†’ UzmanlÄ±k â†’ BÃ¶lÃ¼mler</span>
              </div>
              <div class="grid2">
                <div class="field">
                  <label>Meslek seÃ§</label>
                  <select id="professionSelect"></select>
                  <div class="hint">Listede yoksa "DiÄŸer" seÃ§ ve mesleÄŸini yaz.</div>
                </div>
                <div class="field">
                  <label>UzmanlÄ±k / Alan</label>
                  <select id="specialtySelect"></select>
                </div>
              </div>
              <div class="field">
                <label>MesleÄŸim listede yok</label>
                <input id="professionCustom" type="text" placeholder="Ã–rn: EÄŸitim TeknoloÄŸu / Akademik KoÃ§ / ..." />
              </div>
              <div class="field">
                <label>Hedef kullanÄ±m</label>
                <select id="goalSelect">
                  <option value="job">Ä°ÅŸ BaÅŸvurusu (ATS uyum)</option>
                  <option value="school">Okul/Kurum baÅŸvurusu</option>
                  <option value="freelance">Serbest/Portfolyo</option>
                  <option value="visa">Vize/Resmi</option>
                </select>
              </div>
              <div class="row">
                <button class="mini-btn" id="btnSmartSetup">âš¡ AkÄ±llÄ± Kurulum</button>
                <button class="mini-btn" id="btnSmartSeo">ğŸ” SEO Ã¶ner</button>
                <button class="mini-btn" id="btnSmartCert">ğŸ“ Sertifika Ã¶ner</button>
              </div>
              <div class="hint" id="startHint"></div>
            </div>

            <div class="cardbox">
              <div class="cardbox-head">
                <b>GÃ¶rÃ¼nÃ¼rlÃ¼k</b>
                <span class="tiny">Ä°steÄŸe baÄŸlÄ± bÃ¶lÃ¼mler</span>
              </div>
              <div class="row">
                <label class="pill"><input id="showReferences" type="checkbox" checked> Referanslar</label>
                <label class="pill"><input id="showEssay" type="checkbox" checked> Essay</label>
                <label class="pill"><input id="showAiComment" type="checkbox" checked> AI Yorum</label>
              </div>
              <div class="hint">Not: Bu ayarlar Ã¶nizlemede bÃ¶lÃ¼mleri aÃ§/kapatÄ±r.</div>
            </div>
          </div>

          <!-- PROFILE -->
          <div class="section" id="tabProfile">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>Profil</b>
                <span class="tiny">FotoÄŸraf + temel kimlik</span>
              </div>
              <div class="grid2">
                <div class="field">
                  <label>Ad Soyad</label>
                  <input id="inName" type="text" placeholder="Ã–rn: Zinnur ReÅŸit"/>
                </div>
                <div class="field">
                  <label>BaÅŸlÄ±k / Rol</label>
                  <input id="inRole" type="text" placeholder="Ã–rn: SÄ±nÄ±f Ã–ÄŸretmeni Â· IB PYP"/>
                </div>
              </div>
              <div class="field">
                <label>KÄ±sa vurgulu cÃ¼mle</label>
                <input id="inHighlight" type="text" placeholder="Ã–rn: Sorgulama temelli, Ã¶ÄŸrenci ajansÄ±nÄ± merkeze alan..."/>
                <div class="row">
                  <button class="mini-btn" id="aiHighlightBtn">ğŸ¤– AI ile yaz</button>
                </div>
              </div>
              <div class="grid2">
                <div class="field">
                  <label>Profil fotoÄŸrafÄ± (PNG/JPG)</label>
                  <input id="inPhoto" type="file" accept="image/*"/>
                  <div class="hint">Dikey dikdÃ¶rtgen Â· yumuÅŸak kÃ¶ÅŸe Â· hafif gÃ¶lge</div>
                </div>
                <div class="field">
                  <label>FotoÄŸrafÄ± kaldÄ±r</label>
                  <button class="mini-btn" id="btnClearPhoto">ğŸ§¹ Temizle</button>
                </div>
              </div>
            </div>
          </div>

          <!-- CONTACT -->
          <div class="section" id="tabContact">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>Ä°letiÅŸim</b>
                <span class="tiny">Telefon/konum/LinkedIn + QR</span>
              </div>

              <div class="grid2">
                <div class="field">
                  <label>E-posta</label>
                  <input id="inEmail" type="email" placeholder="ornek@mail.com"/>
                </div>
                <div class="field">
                  <label>LinkedIn / Web</label>
                  <input id="inLink" type="text" placeholder="linkedin.com/in/... veya site"/>
                </div>
              </div>

              <div class="grid2">
                <div class="field">
                  <label>Ãœlke</label>
                  <select id="countrySelect"></select>
                  <div class="hint">Ãœlkeye gÃ¶re telefon formatÄ± otomatik Ã¶nerilir.</div>
                </div>
                <div class="field">
                  <label>Telefon</label>
                  <input id="inPhone" type="tel" placeholder="+90 (5xx) xxx xx xx"/>
                  <div class="hint" id="phoneHint">TR formatÄ±: +90 (5xx) xxx xx xx</div>
                </div>
              </div>

              <div class="grid2">
                <div class="field">
                  <label>Åehir</label>
                  <select id="citySelect"></select>
                  <div class="hint">Ä°stanbul: Avrupa / Anadolu. Semt istersen manuel yaz.</div>
                </div>
                <div class="field">
                  <label>Semt (opsiyonel)</label>
                  <input id="inDistrict" type="text" placeholder="Ã–rn: KadÄ±kÃ¶y / BeÅŸiktaÅŸ / ..."/>
                </div>
              </div>

              <div class="hr"></div>

              <div class="grid2">
                <div class="field">
                  <label>QR iÃ§in URL</label>
                  <input id="inQrUrl" type="text" placeholder="https://..."/>
                  <div class="row">
                    <button class="mini-btn" id="btnGenQr">ğŸ”³ QR oluÅŸtur</button>
                    <button class="mini-btn" id="btnClearQr">ğŸ§¹ QR temizle</button>
                  </div>
                  <div class="hint">URL girip QR Ã¼ret veya aÅŸaÄŸÄ±dan gÃ¶rsel yÃ¼kle.</div>
                </div>
                <div class="field">
                  <label>QR GÃ¶rsel yÃ¼kle (PNG/JPG)</label>
                  <input id="inQrImg" type="file" accept="image/*"/>
                </div>
              </div>

              <div class="field">
                <label>QR aÃ§Ä±klama etiketi</label>
                <input id="inQrLabel" type="text" placeholder="Online CV / Portfolyo"/>
              </div>

              <div class="hr"></div>

              <div class="grid2">
                <div class="field">
                  <label>CV Son GÃ¼ncelleme (Ay/YÄ±l)</label>
                  <input id="inLastUpdate" type="text" placeholder="12/2025"/>
                  <div class="row">
                    <button class="mini-btn" id="btnSetNow">ğŸ—“ï¸ Åimdi gÃ¼ncelle</button>
                  </div>
                </div>
                <div class="field">
                  <label>Beyan</label>
                  <input id="inDeclaration" type="text" value="Bu CVâ€™de yer alan bilgilerin doÄŸru ve gÃ¼ncel olduÄŸunu beyan ederim."/>
                </div>
              </div>
            </div>
          </div>

          <!-- SEO -->
          <div class="section" id="tabSeo">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>Ã‡erÃ§eveler</b>
                <span class="tiny">SeÃ§ime gÃ¶re AI Ã¶neriler hedeflenir</span>
              </div>
              <div class="row">
                <label class="pill"><input id="fwPYP" type="checkbox" checked> PYP</label>
                <label class="pill"><input id="fwUbD" type="checkbox"> UbD</label>
                <label class="pill"><input id="fwSEL" type="checkbox"> SEL</label>
                <label class="pill"><input id="fwSTEM" type="checkbox"> STEM</label>
                <label class="pill"><input id="fwMEB" type="checkbox"> MEB</label>
              </div>
            </div>

            <div class="cardbox">
              <div class="cardbox-head">
                <b>SEO / Anahtar Kavramlar</b>
                <span class="tiny">Her satÄ±r 1 anahtar kelime</span>
              </div>
              <div class="field">
                <label>Anahtar kelimeler</label>
                <textarea id="inKeywords" placeholder="IB PYP&#10;inquiry-based learning&#10;Ã¶ÄŸrenci ajansÄ±"></textarea>
              </div>
              <div class="row">
                <button class="mini-btn" id="aiKeywordsBtn">ğŸ¤– AI ile Ã¶ner</button>
                <button class="mini-btn" id="btnApplyKeywords">âœ… Chipâ€™lere uygula</button>
              </div>
            </div>
          </div>

          <!-- CARDS -->
          <div class="section" id="tabCards">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>Kartlar</b>
                <span class="tiny">Her kartta AI ile doldur</span>
              </div>

              <div class="cardbox">
                <div class="cardbox-head">
                  <b>Kart 1 Â· UzmanlÄ±k</b>
                  <div class="row">
                    <label class="pill"><input id="c1Show" type="checkbox" checked> GÃ¶ster</label>
                    <button class="mini-btn" id="aiCard1">ğŸ¤– AI</button>
                  </div>
                </div>
                <div class="field"><label>BaÅŸlÄ±k</label><input id="c1Title" type="text" value="UzmanlÄ±k AlanlarÄ±"/></div>
                <div class="field"><label>SatÄ±rlar (her satÄ±r 1 madde)</label><textarea id="c1Lines">Ä°lkokul 1â€“4 dÃ¼zeyi
Unit of inquiry planlama</textarea></div>
              </div>

              <div class="cardbox">
                <div class="cardbox-head">
                  <b>Kart 2 Â· YaklaÅŸÄ±m</b>
                  <div class="row">
                    <label class="pill"><input id="c2Show" type="checkbox" checked> GÃ¶ster</label>
                    <button class="mini-btn" id="aiCard2">ğŸ¤– AI</button>
                  </div>
                </div>
                <div class="field"><label>BaÅŸlÄ±k</label><input id="c2Title" type="text" value="EÄŸitim YaklaÅŸÄ±mÄ±"/></div>
                <div class="field"><label>SatÄ±rlar</label><textarea id="c2Lines">Inquiry temelli Ã¶ÄŸrenme
Ã–ÄŸrenci merkezli sÄ±nÄ±f kÃ¼ltÃ¼rÃ¼</textarea></div>
              </div>

              <div class="cardbox">
                <div class="cardbox-head">
                  <b>Kart 3 Â· GÃ¼Ã§lÃ¼ Yanlar</b>
                  <div class="row">
                    <label class="pill"><input id="c3Show" type="checkbox" checked> GÃ¶ster</label>
                    <button class="mini-btn" id="aiCard3">ğŸ¤– AI</button>
                  </div>
                </div>
                <div class="field"><label>BaÅŸlÄ±k</label><input id="c3Title" type="text" value="GÃ¼Ã§lÃ¼ Yanlar"/></div>
                <div class="field"><label>SatÄ±rlar</label><textarea id="c3Lines">Pozitif sÄ±nÄ±f yÃ¶netimi
Veli iletiÅŸimi</textarea></div>
              </div>

              <div class="cardbox">
                <div class="cardbox-head">
                  <b>Kart 4 Â· GeliÅŸim/Sertifikalar</b>
                  <div class="row">
                    <label class="pill"><input id="c4Show" type="checkbox" checked> GÃ¶ster</label>
                    <button class="mini-btn" id="aiCard4">ğŸ¤– AI</button>
                  </div>
                </div>
                <div class="field"><label>BaÅŸlÄ±k</label><input id="c4Title" type="text" value="Mesleki GeliÅŸim & Sertifikalar"/></div>
                <div class="field"><label>SatÄ±rlar</label><textarea id="c4Lines">PYP Category 1
Workshop & seminerler</textarea></div>
              </div>

              <div class="row">
                <button class="mini-btn" id="aiAllCards">ğŸ¤– Hepsini AI ile doldur</button>
              </div>
            </div>
          </div>

          <!-- EDU -->
          <div class="section" id="tabEdu">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>EÄŸitim</b>
                <span class="tiny">Dinamik kartlar</span>
              </div>
              <div id="eduList"></div>
              <div class="row">
                <button class="mini-btn" id="btnAddEdu">+ EÄŸitim ekle</button>
                <button class="mini-btn" id="aiEduAll">ğŸ¤– AI dÃ¼zenle</button>
              </div>
            </div>
          </div>

          <!-- EXP -->
          <div class="section" id="tabExp">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>Deneyim</b>
                <span class="tiny">Dinamik kartlar</span>
              </div>
              <div id="expList"></div>
              <div class="row">
                <button class="mini-btn" id="btnAddExp">+ Deneyim ekle</button>
                <button class="mini-btn" id="aiExpAll">ğŸ¤– AI bullet</button>
              </div>
            </div>
          </div>

          <!-- CERT -->
          <div class="section" id="tabCert">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>Sertifikalar</b>
                <span class="tiny">KÃ¼tÃ¼phane + ekle</span>
              </div>
              <div class="field">
                <label>Ã–nerilen sertifikalar (seÃ§tikÃ§e eklenir)</label>
                <select id="certLibrary"></select>
                <div class="row">
                  <button class="mini-btn" id="btnAddCertFromLib">+ Ekle</button>
                  <button class="mini-btn" id="btnSuggestCert">ğŸ¤– Ã–ner</button>
                </div>
                <div class="hint">PYP/IB odaklÄ± tÃ¼m tÃ¼rleri kaÃ§Ä±rmamak iÃ§in kÃ¼tÃ¼phane burada.</div>
              </div>

              <div class="hr"></div>

              <div id="certList"></div>
              <div class="row">
                <button class="mini-btn" id="btnAddCert">+ Sertifika ekle</button>
              </div>
            </div>
          </div>

          <!-- REFS -->
          <div class="section" id="tabRefs">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>Referanslar</b>
                <span class="tiny">Kartlar + logo/link</span>
              </div>
              <div id="refList"></div>
              <div class="row">
                <button class="mini-btn" id="btnAddRef">+ Referans ekle</button>
                <button class="mini-btn" id="aiRefAll">ğŸ¤– AI aÃ§Ä±klama</button>
              </div>
            </div>
          </div>

          <!-- ESSAY -->
          <div class="section" id="tabEssay">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>Essay / Niyet</b>
                <span class="tiny">AI taslak + SEO kullan</span>
              </div>
              <div class="grid2">
                <div class="field">
                  <label>TÃ¼r</label>
                  <select id="essayType">
                    <option value="motivation">Kariyer niyeti</option>
                    <option value="teaching">Teaching philosophy</option>
                    <option value="cover">Cover letter</option>
                  </select>
                </div>
                <div class="field">
                  <label>Konu</label>
                  <input id="essayTitle" type="text" placeholder="Ã–rn: Inquiry ve Ã¶ÄŸrenci ajansÄ±"/>
                </div>
              </div>
              <div class="field">
                <label>Hedef kurum / pozisyon</label>
                <input id="essayTarget" type="text" placeholder="Ã–rn: X Koleji Â· PYP Class Teacher"/>
              </div>
              <div class="field">
                <label>Metin</label>
                <textarea id="essayText" placeholder="AI ile yaz veya manuel ekle."></textarea>
              </div>
              <div class="row">
                <button class="mini-btn" id="aiEssayBtn">ğŸ¤– AI ile yaz</button>
                <button class="mini-btn" id="btnClearEssay">ğŸ§¹ Temizle</button>
              </div>
            </div>
          </div>

          <!-- AI STUDIO -->
          <div class="section" id="tabAI">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>AI StÃ¼dyo</b>
                <span class="tiny">Kural tabanlÄ± â€œakÄ±llÄ± taslakâ€ + isteÄŸe baÄŸlÄ±</span>
              </div>
              <div class="field">
                <label>AI Rehber Notu</label>
                <textarea id="aiGuide" placeholder="Buraya hedefini yaz. AI, Ã§erÃ§eve+SEOâ€™ya gÃ¶re taslak Ã¼retir."></textarea>
              </div>
              <div class="row">
                <button class="mini-btn" id="aiRunAll">ğŸš€ AkÄ±llÄ± doldur</button>
                <button class="mini-btn" id="aiCvComment">ğŸ§  AI CV yorumu Ã¼ret</button>
              </div>
              <div class="field" style="margin-top:10px;">
                <label>AI Ã‡Ä±ktÄ± / Log</label>
                <textarea id="aiLog" readonly></textarea>
                <div class="hint">Not: Bu demo sÃ¼rÃ¼mde AI â€œÅŸablon + baÄŸlamâ€ mantÄ±ÄŸÄ±yla Ã§alÄ±ÅŸÄ±r. GerÃ§ek API entegrasyonu eklenebilir.</div>
              </div>

              <div class="hr"></div>

              <div class="field">
                <label>GeliÅŸtirici opsiyonu (isteÄŸe baÄŸlÄ±)</label>
                <div class="hint">
                  Ä°stersen ileride, sunucu taraflÄ± bir servisle ChatGPT API baÄŸlanÄ±r; gÃ¼venli anahtar yÃ¶netimi gerekir.
                  Bu tek-dosya HTML iÃ§inde anahtar saklamak gÃ¼venli deÄŸildir.
                </div>
              </div>
            </div>
          </div>

          <!-- FEEDBACK -->
          
    <div class="section" id="tabManage">
      <h2>YÃ¶netim</h2>
      <div class="subtle">BaÅŸlÄ±klarÄ± yeniden adlandÄ±r, bÃ¶lÃ¼mleri gizle/gÃ¶ster, Ã¶zel kartlar/patchâ€™ler ekle ve â€œSon Silinenlerâ€den geri yÃ¼kle. (Veriler tarayÄ±cÄ±nda saklanÄ±r.)</div>

      <div class="card">
        <div class="card-title">BaÅŸlÄ±klarÄ± yeniden adlandÄ±r</div>
        <div class="grid2">
          <label>EÄŸitim <input id="titleEdu" class="input" placeholder="EÄŸitim"></label>
          <label>Deneyim <input id="titleExp" class="input" placeholder="Deneyim"></label>
          <label>Sertifikalar <input id="titleCert" class="input" placeholder="Sertifikalar"></label>
          <label>Referanslar <input id="titleRefs" class="input" placeholder="Referanslar"></label>
          <label>Kariyer PlanÄ± <input id="titleEssay" class="input" placeholder="Kariyer PlanÄ± / Hedef"></label>
          <label>AI CV Yorumu <input id="titleAi" class="input" placeholder="AI CV Yorumu"></label>
        </div>
        <div class="row">
          <button class="btn" id="btnSaveTitles">Kaydet</button>
          <button class="btn ghost" id="btnResetTitles">VarsayÄ±lana dÃ¶n</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">BÃ¶lÃ¼mleri gÃ¶ster / gizle</div>
        <div class="chips" style="gap:10px; flex-wrap:wrap;">
          <label class="chip"><input type="checkbox" id="showEdu"> EÄŸitim</label>
          <label class="chip"><input type="checkbox" id="showExp"> Deneyim</label>
          <label class="chip"><input type="checkbox" id="showCert"> Sertifikalar</label>
          <label class="chip"><input type="checkbox" id="showRefs2"> Referanslar</label>
          <label class="chip"><input type="checkbox" id="showEssay2"> Kariyer PlanÄ±</label>
          <label class="chip"><input type="checkbox" id="showAiComment2"> AI CV Yorumu</label>
          <label class="chip"><input type="checkbox" id="showCustom"> Ã–zel BÃ¶lÃ¼mler</label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Ã–zel kart / patch ekle</div>
        <div class="grid2">
          <label>TÃ¼r
            <select id="customKind" class="input">
              <option value="card">CV KartÄ± (metin)</option>
              <option value="html">Ham HTML (CV iÃ§inde)</option>
              <option value="js">JS (sayfada Ã§alÄ±ÅŸtÄ±r)</option>
            </select>
          </label>
          <label>BaÅŸlÄ±k <input id="customTitle" class="input" placeholder="Ã–rn: Projeler / YayÄ±nlar / Ã–dÃ¼ller"></label>
        </div>
        <label>Ä°Ã§erik
          <textarea id="customBody" class="input" rows="6" placeholder="Metin / HTML / JS"></textarea>
        </label>
        <div class="row">
          <button class="btn" id="btnAddCustom">Ekle</button>
          <button class="btn ghost" id="btnRunAllJsPatches">TÃ¼m JS patchâ€™leri Ã§alÄ±ÅŸtÄ±r</button>
        </div>
        <div class="subtle" style="margin-top:8px">
          Not: â€œHam HTMLâ€ ve â€œJSâ€ patchâ€™leri sayfaya kod ekler. HatalÄ±/Ã§akÄ±ÅŸan kodlarÄ± â€œSon Silinenlerâ€ Ã¼zerinden geri alabilir veya kalÄ±cÄ± silebilirsin.
        </div>
        <div id="customList" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <div class="card-title">Geri dÃ¶nÃ¼ÅŸÃ¼m (Son Silinenler)</div>
        <div class="subtle">Silinen eÄŸitim/deneyim/referans/Ã¶zel kartlar buraya dÃ¼ÅŸer. Geri yÃ¼kleyebilir veya kalÄ±cÄ± silebilirsin.</div>
        <div id="trashList" style="margin-top:10px"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn ghost" id="btnClearTrash">Ã‡Ã¶p kutusunu boÅŸalt</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">PaylaÅŸÄ±m modu</div>
        <label class="row" style="gap:10px; align-items:center;">
          <input type="checkbox" id="shareMode"> <span>Paneli gizle, sadece CV Ã¶nizlemesi gÃ¶ster</span>
        </label>
        <label class="row" style="gap:10px; align-items:center; margin-top:8px;">
          <input type="checkbox" id="redactMode"> <span>Hassas bilgileri karart (telefon/eâ€‘posta)</span>
        </label>
        <div class="subtle" style="margin-top:10px">
          Ã–nemli: Bu dosya GitHub gibi â€œpublicâ€ yerdeyse kodlar tamamen gizlenemez. KiÅŸisel veriler <b>tarayÄ±cÄ±daki</b> kayÄ±tta kalÄ±r (localStorage). PaylaÅŸÄ±rken â€œPaylaÅŸÄ±m modu + Karartmaâ€ kullan.
        </div>
      </div>
    </div>

<div class="section" id="tabFeedback">
            <div class="cardbox">
              <div class="cardbox-head">
                <b>Geri Bildirim & Hata AvcÄ±sÄ±</b>
                <span class="tiny">Otomatik tarama + log</span>
              </div>
              <div class="row">
                <button class="mini-btn" id="btnScan">ğŸ” Hata tara</button>
                <button class="mini-btn" id="btnFixHints">ğŸ› ï¸ AkÄ±llÄ± Ã¶neri</button>
                <button class="mini-btn" id="btnClearLogs">ğŸ§¹ Log temizle</button>
              </div>
              <div class="field" style="margin-top:10px;">
                <label>Geri bildirim yaz</label>
                <textarea id="fbText" placeholder="Sorunu yaz: nerede, ne yaptÄ±n, ne bekledin, ne oldu?"></textarea>
              </div>
              <div class="row">
                <button class="mini-btn" id="btnSaveFeedback">ğŸ’¾ Logâ€™a kaydet</button>
                <button class="mini-btn" id="btnAiFeedback">ğŸ¤– AI ile netleÅŸtir</button>
              </div>

              <div class="field" style="margin-top:10px;">
                <label>Log</label>
                <textarea id="fbLog" readonly></textarea>
                <div class="hint">Bu log localStorageâ€™a kaydedilir. Test sÃ¼recinde nokta atÄ±ÅŸÄ± dÃ¼zeltme listesi Ã§Ä±karÄ±r.</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Preview -->
    <div class="preview-wrap">
      <div class="preview-head">
        <div class="left">
          <b>CV Ã–nizleme</b>
          <span id="previewInfo">A4 Â· CanlÄ±</span>
        </div>
        <div class="row">
          <button class="btn good" id="btnExportJson" title="Yerel yedek (JSON)">ğŸ’¾ Yedek</button>
          <button class="btn" id="btnImportJson" title="Yerel geri yÃ¼kle (JSON)">ğŸ“¥ YÃ¼kle</button>
        </div>
      </div>
      <div class="preview-body">
        <div class="paper" id="paper">
          <div class="cv-topbar">
            <div>
              <div style="font-weight:800; font-size:12px;" id="cvNameRole">Ad Soyad Â· Rol</div>
              <div class="contact-lines">
                <div>
                  <span>âœ‰ <span id="cvEmail">mail@ornek.com</span></span>
                  <span>â˜ <span id="cvPhone">+90 (5xx) xxx xx xx</span></span>
                </div>
                <div>
                  <span>ğŸ“ <span id="cvLocation">Ä°stanbul (Avrupa)</span></span>
                  <span>ğŸ”— <span id="cvLink">linkedin.com/in/...</span></span>
                </div>
              </div>
            </div>
            <div style="text-align:right">
              <div class="qrbox" id="qrBox"><span style="font-size:10px; color:#6b7280">QR</span></div>
              <div class="qr-cap" id="qrCap">Online CV / Portfolyo</div>
            </div>
          </div>

          <div class="profile">
            <div class="cv-card">
              <div class="p-head">
                <div class="photo" id="cvPhoto">CV</div>
                <div>
                  <div class="name" id="cvName">Ad Soyad</div>
                  <div class="role" id="cvRole">BaÅŸlÄ±k / Rol</div>
                </div>
              </div>

              <div class="chips" id="chipWrap"></div>

              <div class="highlight" id="cvHighlight">
                <span>âœ¨</span>
                <span id="highlightText">Sorgulama temelli ve Ã¶ÄŸrenci ajansÄ±nÄ± merkeze alan...</span>
              </div>

              <div class="mini-grid">
                <div class="cv-card" id="mini1">
                  <div class="mini-title" id="mini1Title">UzmanlÄ±k AlanlarÄ±</div>
                  <ul class="mini-list" id="mini1List"></ul>
                </div>
                <div class="cv-card" id="mini2">
                  <div class="mini-title" id="mini2Title">EÄŸitim YaklaÅŸÄ±mÄ±</div>
                  <ul class="mini-list" id="mini2List"></ul>
                </div>
                <div class="cv-card" id="mini3">
                  <div class="mini-title" id="mini3Title">GÃ¼Ã§lÃ¼ Yanlar</div>
                  <ul class="mini-list" id="mini3List"></ul>
                </div>
                <div class="cv-card" id="mini4">
                  <div class="mini-title" id="mini4Title">Mesleki GeliÅŸim & Sertifikalar</div>
                  <ul class="mini-list" id="mini4List"></ul>
                </div>
              </div>
            </div>

            <div class="cv-card">
              <div class="mini-title">Ã–zet Not</div>
              <div class="sec-body" id="cvSummary">
                Bu CV, seÃ§tiÄŸin Ã§erÃ§eveler ve SEO anahtar kelimeleriyle hedefli ÅŸekilde oluÅŸturulur.
              </div>
              <div class="hr"></div>
              <div class="mini-title">Sertifika Ã–zeti</div>
              <div class="sec-body" id="cvCertSummary">HenÃ¼z eklenmedi.</div>
            </div>
          </div>

          <div class="sec-title" id="secEduTitle">EÄŸitim</div>
          <div class="sec-body" id="cvEdu"></div>

          <div class="sec-title" id="secExpTitle">Deneyim</div>
          <div class="sec-body" id="cvExp"></div>

          <div class="sec-title" id="secCertTitle">Sertifikalar</div>
          <div class="sec-body" id="cvCerts"></div>

          <div class="sec-title" id="secRefTitle">Referanslar</div>
          <div class="sec-body" id="cvRefs"></div>

          <div class="sec-title" id="secEssayTitle">Essay</div>
          <div class="cv-card" id="cvEssayCard">
            <div class="meta" id="cvEssayMeta">TÃ¼r: Kariyer niyeti Â· Hedef: - Â· Konu: -</div>
            <div class="sec-body" id="cvEssayText">â€”</div>
          </div>

          <div class="sec-title" id="secAiTitle">AI CV Yorumu</div>
          <div class="cv-card" id="cvAiCard">
            <div class="sec-body" id="cvAiComment">â€”</div>
          </div>

          <div id="cvCustomSections"></div>

          <div class="footer">
            <div id="cvLastUpdate"></div>
            <div id="cvDeclaration"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal A4 -->
  <div class="modal" id="a4Modal">
    <div class="modal-box">
      <div class="modal-top">
        <b>A4 Ã–nizleme</b>
        <div class="row">
          <button class="btn" id="btnModalPrint">ğŸ–¨ï¸ YazdÄ±r/PDF</button>
          <button class="btn" id="btnModalClose">âœ•</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="a4Holder"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Kaydedildi</div>
</div>

<!-- Optional: QR library (fallbacks exist) -->
<script>
/* ========= tiny helpers ========= */
const $ = (id)=>document.getElementById(id);
const LS_KEY = "AKILLI_CV_PLATFORM_V1_STATE";
const LOG_KEY = "AKILLI_CV_PLATFORM_V1_FEEDBACK";
const toast = (msg)=>{
  const t=$("toast"); t.textContent=msg; t.style.display="block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer=setTimeout(()=>t.style.display="none",1400);
};
const safe = (s)=> (s||"").toString().replace(/[<>]/g,"");
const lines = (t)=> (t||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
const nowMMYYYY = ()=>{
  const d=new Date(); const m=String(d.getMonth()+1).padStart(2,"0"); return `${m}/${d.getFullYear()}`;
};

/* ========= theme / device ========= */
function applyTheme(mode){
  if(mode==="light") document.documentElement.setAttribute("data-theme","light");
  else if(mode==="dark") document.documentElement.setAttribute("data-theme","dark");
  else document.documentElement.setAttribute("data-theme","system");
  localStorage.setItem("AKILLI_THEME", mode);
}
function setSegActive(groupIds, activeId){
  groupIds.forEach(id=>$(id).classList.toggle("active", id===activeId));
}
function applyDevice(mode){
  // No transform scaling. Only layout hint.
  $("previewInfo").textContent = "A4 Â· CanlÄ± Â· " + (mode==="mobile" ? "Mobil" : "MasaÃ¼stÃ¼");
  localStorage.setItem("AKILLI_DEVICE", mode);
}

/* ========= profession & specialty ========= */
const PROFESSIONS = [
  "Avukat","Doktor","Ã–ÄŸretmen","MÃ¼hendis","YazÄ±lÄ±mcÄ±","TasarÄ±mcÄ±","Muhasebeci","Pazarlama UzmanÄ±",
  "SatÄ±ÅŸ UzmanÄ±","Ä°K UzmanÄ±","ÅofÃ¶r","AÅŸÃ§Ä±","HemÅŸire","DiÅŸ Hekimi","EczacÄ±","Psikolog","Mimar",
  "Proje YÃ¶neticisi","ÃœrÃ¼n YÃ¶neticisi","Serbest Meslek","DiÄŸer"
].sort((a,b)=>a.localeCompare(b,"tr"));
const SPECIALTIES = {
  "Ã–ÄŸretmen":["SÄ±nÄ±f Ã–ÄŸretmeni","PYP Ã–ÄŸretmeni","BranÅŸ Ã–ÄŸretmeni","Rehberlik","Okul Ã–ncesi","DiÄŸer"],
  "Doktor":["Pratisyen","UzmanlÄ±k AdayÄ±","Dahiliye","Cerrahi","Pediatri","DiÄŸer"],
  "Avukat":["Ceza","Ä°ÅŸ Hukuku","Ticaret","Aile","Åirket","DiÄŸer"],
  "MÃ¼hendis":["YazÄ±lÄ±m","Elektrik-Elektronik","Makine","Ä°nÅŸaat","EndÃ¼stri","DiÄŸer"],
  "Serbest Meslek":["DanÄ±ÅŸman","KoÃ§","EÄŸitmen","Freelance","DiÄŸer"],
  "DiÄŸer":["Genel","DiÄŸer"]
};
function rebuildSpecialties(){
  const p = $("professionSelect").value;
  const list = SPECIALTIES[p] || ["Genel","DiÄŸer"];
  $("specialtySelect").innerHTML = list.map(x=>`<option value="${x}">${x}</option>`).join("");
}

/* ========= country / city / phone ========= */
const COUNTRIES = [
  {code:"TR", name:"TÃ¼rkiye", dial:"+90", pattern:"TR", max:10, hint:"+90 (5xx) xxx xx xx"},
  {code:"US", name:"United States", dial:"+1", pattern:"US", max:10, hint:"+1 (xxx) xxx-xxxx"},
  {code:"GB", name:"United Kingdom", dial:"+44", pattern:"GB", max:10, hint:"+44 xxxx xxx xxxx"},
  {code:"DE", name:"Deutschland", dial:"+49", pattern:"DE", max:11, hint:"+49 xxxx xxxxxx"},
  {code:"OTHER", name:"DiÄŸer (manuel)", dial:"+", pattern:"GEN", max:16, hint:"+[Ã¼lke] [numara]"}
];
function buildCountry(){
  $("countrySelect").innerHTML = COUNTRIES.map(c=>`<option value="${c.code}">${c.name} (${c.dial})</option>`).join("");
}
function buildCity(){
  $("citySelect").innerHTML = `
    <option value="Ä°stanbul (Avrupa)">Ä°stanbul (Avrupa)</option>
    <option value="Ä°stanbul (Anadolu)">Ä°stanbul (Anadolu)</option>
    <option value="Ankara">Ankara</option>
    <option value="Ä°zmir">Ä°zmir</option>
    <option value="Bursa">Bursa</option>
    <option value="DiÄŸer">DiÄŸer</option>
  `;
}
function digitsOnly(v){ return (v||"").replace(/\D/g,""); }
function formatPhone(countryCode, raw){
  const c = COUNTRIES.find(x=>x.code===countryCode) || COUNTRIES[0];
  let d = digitsOnly(raw);
  // remove leading country digits if user pasted full
  if(c.code==="TR"){
    if(d.startsWith("90")) d = d.slice(2);
    if(d.startsWith("0")) d = d.slice(1);
    d = d.slice(0,10);
    let out = "+90";
    if(d.length){
      out += " (" + d.slice(0,3);
      if(d.length>=3) out += ")";
      if(d.length>3) out += " " + d.slice(3,6);
      if(d.length>6) out += " " + d.slice(6,8);
      if(d.length>8) out += " " + d.slice(8,10);
    }
    return out;
  }
  // basic formats for others (simple, not perfect for every country)
  if(c.code==="US"){
    d = d.replace(/^1/,"").slice(0,10);
    let out = "+1";
    if(d.length){
      out += " (" + d.slice(0,3) + ")";
      if(d.length>3) out += " " + d.slice(3,6);
      if(d.length>6) out += "-" + d.slice(6,10);
    }
    return out;
  }
  if(c.code==="GB"){
    d = d.replace(/^44/,"").slice(0,10);
    let out = "+44";
    if(d.length){
      out += " " + d.slice(0,4);
      if(d.length>4) out += " " + d.slice(4,7);
      if(d.length>7) out += " " + d.slice(7,10);
    }
    return out;
  }
  if(c.code==="DE"){
    d = d.replace(/^49/,"").slice(0,11);
    let out = "+49";
    if(d.length){
      out += " " + d.slice(0,4);
      if(d.length>4) out += " " + d.slice(4);
    }
    return out;
  }
  // generic
  d = d.slice(0, c.max || 16);
  return (c.dial==="+" ? "+" : c.dial) + " " + d;
}
function phoneMaxForCountry(code){
  const c = COUNTRIES.find(x=>x.code===code) || COUNTRIES[0];
  $("phoneHint").textContent = c.hint || "Telefon formatÄ±";
}

/* ========= data model ========= */
let state = {
  profession:"Ã–ÄŸretmen", specialty:"SÄ±nÄ±f Ã–ÄŸretmeni", professionCustom:"",
  goal:"job",
  show:{refs:true, essay:true, aiComment:true},
  profile:{name:"", role:"", highlight:"", photoData:""},
  contact:{email:"", link:"", country:"TR", phone:"", city:"Ä°stanbul (Avrupa)", district:"", qrUrl:"", qrLabel:"Online CV / Portfolyo", qrImg:"", lastUpdate:"", declaration:"Bu CVâ€™de yer alan bilgilerin doÄŸru ve gÃ¼ncel olduÄŸunu beyan ederim."},
  seo:{frameworks:{pyp:true, ubd:false, sel:false, stem:false, meb:false}, keywords:["IB PYP","inquiry-based learning","Ã¶ÄŸrenci ajansÄ±"]},
  cards:{
    c1:{show:true,title:"UzmanlÄ±k AlanlarÄ±",lines:["Ä°lkokul 1â€“4 dÃ¼zeyi","Unit of inquiry planlama"]},
    c2:{show:true,title:"EÄŸitim YaklaÅŸÄ±mÄ±",lines:["Inquiry temelli Ã¶ÄŸrenme","Ã–ÄŸrenci merkezli sÄ±nÄ±f kÃ¼ltÃ¼rÃ¼"]},
    c3:{show:true,title:"GÃ¼Ã§lÃ¼ Yanlar",lines:["Pozitif sÄ±nÄ±f yÃ¶netimi","Veli iletiÅŸimi"]},
    c4:{show:true,title:"Mesleki GeliÅŸim & Sertifikalar",lines:["PYP Category 1","Workshop & seminerler"]},
  },
  edu:[],
  exp:[],
  certs:[],
  refs:[],
  essay:{type:"motivation", title:"", target:"", text:""},
  ai:{comment:"", guide:"", log:""},
  feedback:{log:""}
};

function saveState(){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    $("statePill").textContent = "Kaydedildi";
    toast("Kaydedildi");
  }catch(e){
    $("statePill").textContent = "KayÄ±t hatasÄ±";
  }
}
let saveTimer=null;
function scheduleSave(){
  $("statePill").textContent = "Kaydediliyorâ€¦";
  clearTimeout(saveTimer);
  saveTimer=setTimeout(saveState, 250);
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw) state = Object.assign(state, JSON.parse(raw));
  }catch(e){}
}

/* ========= UI binding ========= */
function setTab(tabId){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tabId));
  document.querySelectorAll(".section").forEach(s=>s.classList.toggle("active", s.id===tabId));
}
function openPanel(open){
  const drawer=$("drawer"), overlay=$("overlay");
  if(open){
    drawer.classList.add("open"); overlay.classList.add("open");
  } else {
    drawer.classList.remove("open"); overlay.classList.remove("open");
  }
}

/* ========= CV rendering ========= */
function renderChips(){
  const wrap=$("chipWrap");
  wrap.innerHTML="";
  (state.seo.keywords||[]).slice(0,16).forEach(k=>{
    const s=document.createElement("span"); s.className="chip"; s.textContent=k; wrap.appendChild(s);
  });
}
function renderCardLists(){
  const map = [
    ["c1","mini1","mini1Title","mini1List", $("c1Show")],
    ["c2","mini2","mini2Title","mini2List", $("c2Show")],
    ["c3","mini3","mini3Title","mini3List", $("c3Show")],
    ["c4","mini4","mini4Title","mini4List", $("c4Show")],
  ];
  map.forEach(([k, boxId, titleId, listId])=>{
    const data=state.cards[k];
    $(titleId).textContent = data.title || "";
    const ul=$(listId); ul.innerHTML="";
    (data.lines||[]).forEach(l=>{
      const li=document.createElement("li"); li.textContent=l; ul.appendChild(li);
    });
    $(boxId).style.display = data.show ? "" : "none";
  });
}
function renderEdu(){
  const c=$("cvEdu"); c.innerHTML="";
  if(!state.edu.length){ c.innerHTML = '<div class="item"><b>â€”</b><div class="meta">HenÃ¼z eklenmedi</div></div>'; return; }
  state.edu.forEach(e=>{
    const div=document.createElement("div"); div.className="item";
    div.innerHTML = `<b>${safe(e.program||"EÄŸitim")} ${e.degree?`(${safe(e.degree)})`:""}${e.school?` â€“ ${safe(e.school)}`:""}</b>
      <div class="meta">${safe([e.dates,e.location].filter(Boolean).join(" Â· "))}</div>
      ${e.notes?`<div>${safe(e.notes)}</div>`:""}`;
    c.appendChild(div);
  });
}
function renderExp(){
  const c=$("cvExp"); c.innerHTML="";
  if(!state.exp.length){ c.innerHTML = '<div class="item"><b>â€”</b><div class="meta">HenÃ¼z eklenmedi</div></div>'; return; }
  state.exp.forEach(e=>{
    const div=document.createElement("div"); div.className="item";
    const bullets=(e.bullets||[]).map(b=>`<li>${safe(b)}</li>`).join("");
    div.innerHTML = `<b>${safe(e.org||"Kurum")}${e.role?` â€“ ${safe(e.role)}`:""}</b>
      <div class="meta">${safe([e.location,e.dates].filter(Boolean).join(" Â· "))}</div>
      ${(e.tags||[]).length?`<div class="meta">Etiketler: ${safe(e.tags.join(", "))}</div>`:""}
      ${bullets?`<ul class="bul">${bullets}</ul>`:""}`;
    c.appendChild(div);
  });
}
function renderCerts(){
  const c=$("cvCerts"); c.innerHTML="";
  if(!state.certs.length){ c.innerHTML = '<div class="item"><b>â€”</b><div class="meta">HenÃ¼z eklenmedi</div></div>'; $("cvCertSummary").textContent="HenÃ¼z eklenmedi."; return; }
  state.certs.forEach(s=>{
    const div=document.createElement("div"); div.className="item";
    div.innerHTML = `<b>${safe(s.title||"Sertifika")}</b>
      <div class="meta">${safe([s.issuer,s.year].filter(Boolean).join(" Â· "))}</div>`;
    c.appendChild(div);
  });
  $("cvCertSummary").textContent = state.certs.slice(0,4).map(x=>x.title).filter(Boolean).join(" Â· ") + (state.certs.length>4 ? " Â· â€¦" : "");
}
function renderRefs(){
  const secTitle=$("secRefTitle"), secBody=$("cvRefs");
  secTitle.style.display = state.show.refs ? "" : "none";
  secBody.style.display = state.show.refs ? "" : "none";
  if(!state.show.refs) return;
  secBody.innerHTML="";
  if(!state.refs.length){ secBody.innerHTML = '<div class="item"><b>â€”</b><div class="meta">HenÃ¼z eklenmedi</div></div>'; return; }
  state.refs.forEach(r=>{
    const div=document.createElement("div"); div.className="item";
    div.innerHTML = `<b>${safe(r.name||"Referans")} ${r.role?`â€” ${safe(r.role)}`:""}</b>
      <div class="meta">${safe([r.relation,r.period].filter(Boolean).join(" Â· "))}</div>
      ${r.focus?`<div>${safe(r.focus)}</div>`:""}`;
    secBody.appendChild(div);
  });
}
function renderEssay(){
  const st=$("secEssayTitle"), card=$("cvEssayCard");
  st.style.display = state.show.essay ? "" : "none";
  card.style.display = state.show.essay ? "" : "none";
  if(!state.show.essay) return;
  const typeLabel = state.essay.type==="teaching"?"Teaching philosophy":state.essay.type==="cover"?"Cover letter":"Kariyer niyeti";
  $("cvEssayMeta").textContent = `TÃ¼r: ${typeLabel} Â· Hedef: ${state.essay.target||"-"} Â· Konu: ${state.essay.title||"-"}`;
  $("cvEssayText").textContent = state.essay.text || "â€”";
}
function renderAIComment(){
  const st=$("secAiTitle"), card=$("cvAiCard");
  st.style.display = state.show.aiComment ? "" : "none";
  card.style.display = state.show.aiComment ? "" : "none";
  if(!state.show.aiComment) return;
  $("cvAiComment").textContent = state.ai.comment || "â€”";
}
function renderFooter(){
  $("cvLastUpdate").textContent = state.contact.lastUpdate ? `CV son gÃ¼ncelleme: ${state.contact.lastUpdate}` : "";
  $("cvDeclaration").textContent = state.contact.declaration || "";
}
function renderHeader(){
  const name = state.profile.name || "Ad Soyad";
  const role = state.profile.role || "BaÅŸlÄ±k / Rol";
  $("cvNameRole").textContent = `${name} Â· ${role}`;
  $("cvName").textContent = name;
  $("cvRole").textContent = role;

  $("highlightText").textContent = state.profile.highlight || "â€”";
  $("cvEmail").textContent = state.contact.email || "mail@ornek.com";
  $("cvLink").textContent = state.contact.link || "linkedin.com/in/...";
  $("cvPhone").textContent = state.contact.phone || "+90 (5xx) xxx xx xx";

  const locParts = [];
  if(state.contact.city) locParts.push(state.contact.city);
  if(state.contact.district) locParts.push(state.contact.district);
  $("cvLocation").textContent = locParts.join(" Â· ") || "â€”";

  // photo
  const photo=$("cvPhoto");
  if(state.profile.photoData){
    photo.innerHTML = `<img alt="profil" src="${state.profile.photoData}">`;
  } else {
    const initials = (name||"").split(" ").filter(Boolean).slice(0,2).map(w=>w[0].toUpperCase()).join("") || "CV";
    photo.textContent = initials;
    photo.innerHTML = initials;
  }

  // qr
  const qb=$("qrBox");
  qb.innerHTML = "";
  if(state.contact.qrImg){
    qb.innerHTML = `<img alt="qr" src="${state.contact.qrImg}">`;
  } else if(state.contact.qrData){
    qb.innerHTML = `<img alt="qr" src="${state.contact.qrData}">`;
  } else {
    qb.innerHTML = `<span style="font-size:10px; color:#6b7280">QR</span>`;
  }
  $("qrCap").textContent = state.contact.qrLabel || "Online CV / Portfolyo";
}
function renderAll(){
  renderHeader();
  renderChips();
  renderCardLists();
  renderEdu();
  renderExp();
  renderCerts();
  renderRefs();
  renderEssay();
  renderAIComment();
  renderFooter();
}

/* ========= dynamic lists UI ========= */
function eduCardTemplate(item, idx){
  return `
  <div class="cardbox">
    <div class="cardbox-head">
      <b>EÄŸitim #${idx+1}</b>
      <div class="row">
        <button class="mini-btn" data-act="ai">ğŸ¤– AI</button>
        <button class="mini-btn" data-act="del">Sil</button>
      </div>
    </div>
    <div class="grid2">
      <div class="field"><label>Derece</label><input data-k="degree" value="${safe(item.degree||"")}"></div>
      <div class="field"><label>Program</label><input data-k="program" value="${safe(item.program||"")}"></div>
    </div>
    <div class="field"><label>Kurum</label><input data-k="school" value="${safe(item.school||"")}"></div>
    <div class="grid2">
      <div class="field"><label>Åehir/Ãœlke</label><input data-k="location" value="${safe(item.location||"")}"></div>
      <div class="field"><label>Tarih</label><input data-k="dates" value="${safe(item.dates||"")}"></div>
    </div>
    <div class="field"><label>KÄ±sa aÃ§Ä±klama</label><textarea data-k="notes">${safe(item.notes||"")}</textarea></div>
  </div>`;
}
function rebuildEduUI(){
  const wrap=$("eduList");
  wrap.innerHTML = state.edu.map(eduCardTemplate).join("") || `<div class="tiny">HenÃ¼z eÄŸitim eklenmedi.</div>`;
  wrap.querySelectorAll(".cardbox").forEach((box,idx)=>{
    box.querySelectorAll("input,textarea").forEach(el=>{
      el.addEventListener("input", ()=>{
        const k=el.dataset.k; state.edu[idx][k]=el.value; scheduleSave(); renderAll();
      });
    });
    box.querySelector('[data-act="del"]')?.addEventListener("click", ()=>{
      state.edu.splice(idx,1); scheduleSave(); rebuildEduUI(); renderAll();
    });
    box.querySelector('[data-act="ai"]')?.addEventListener("click", ()=>{
      const p = state.edu[idx].program || "Program";
      state.edu[idx].notes = `${p} sÃ¼recinde Ã¶ÄŸretim tasarÄ±mÄ±, Ã¶lÃ§me-deÄŸerlendirme ve sÄ±nÄ±f yÃ¶netimi alanlarÄ±nda geliÅŸim saÄŸladÄ±m.`;
      scheduleSave(); rebuildEduUI(); renderAll();
      aiLog(`EÄŸitim #${idx+1} iÃ§in AI aÃ§Ä±klama oluÅŸturuldu.`);
    });
  });
}

function expCardTemplate(item, idx){
  return `
  <div class="cardbox">
    <div class="cardbox-head">
      <b>Deneyim #${idx+1}</b>
      <div class="row">
        <button class="mini-btn" data-act="ai">ğŸ¤– AI</button>
        <button class="mini-btn" data-act="del">Sil</button>
      </div>
    </div>
    <div class="grid2">
      <div class="field"><label>Kurum</label><input data-k="org" value="${safe(item.org||"")}"></div>
      <div class="field"><label>Pozisyon</label><input data-k="role" value="${safe(item.role||"")}"></div>
    </div>
    <div class="grid2">
      <div class="field"><label>Konum</label><input data-k="location" value="${safe(item.location||"")}"></div>
      <div class="field"><label>Tarih</label><input data-k="dates" value="${safe(item.dates||"")}"></div>
    </div>
    <div class="field"><label>Etiketler (virgÃ¼l)</label><input data-k="tags" value="${safe((item.tags||[]).join(", "))}"></div>
    <div class="field"><label>Bullet (her satÄ±r 1)</label><textarea data-k="bullets">${safe((item.bullets||[]).join("\n"))}</textarea></div>
  </div>`;
}
function rebuildExpUI(){
  const wrap=$("expList");
  wrap.innerHTML = state.exp.map(expCardTemplate).join("") || `<div class="tiny">HenÃ¼z deneyim eklenmedi.</div>`;
  wrap.querySelectorAll(".cardbox").forEach((box,idx)=>{
    box.querySelectorAll("input,textarea").forEach(el=>{
      el.addEventListener("input", ()=>{
        const k=el.dataset.k;
        if(k==="tags") state.exp[idx].tags = el.value.split(",").map(x=>x.trim()).filter(Boolean);
        else if(k==="bullets") state.exp[idx].bullets = lines(el.value);
        else state.exp[idx][k]=el.value;
        scheduleSave(); renderAll();
      });
    });
    box.querySelector('[data-act="del"]')?.addEventListener("click", ()=>{
      state.exp.splice(idx,1); scheduleSave(); rebuildExpUI(); renderAll();
    });
    box.querySelector('[data-act="ai"]')?.addEventListener("click", ()=>{
      const tags = (state.exp[idx].tags||[]).join(" ").toLowerCase();
      const bullets=[];
      if(state.seo.frameworks.pyp || tags.includes("pyp")) bullets.push("Inquiry temelli unit planlarÄ± tasarladÄ±m ve Ã¶ÄŸrenci ajansÄ±nÄ± gÃ¼Ã§lendiren rutinler oluÅŸturdum.");
      if(state.seo.frameworks.ubd || tags.includes("ubd")) bullets.push("UbD yaklaÅŸÄ±mÄ±yla hedefâ€“kanÄ±tâ€“Ã¶ÄŸrenme deneyimlerini uyumlu hale getirdim.");
      if(state.seo.frameworks.sel || tags.includes("sel")) bullets.push("Sosyo-duygusal geliÅŸimi destekleyen sÄ±nÄ±f iklimi ve iliÅŸki temelli yÃ¶netim uyguladÄ±m.");
      if(!bullets.length) bullets.push("Ã–ÄŸrenci merkezli Ã¶ÄŸrenme deneyimleri tasarladÄ±m ve dÃ¼zenli geri bildirim dÃ¶ngÃ¼leri kurdum.");
      state.exp[idx].bullets = bullets;
      scheduleSave(); rebuildExpUI(); renderAll();
      aiLog(`Deneyim #${idx+1} iÃ§in AI bullet oluÅŸturuldu.`);
    });
  });
}

function certTemplate(item, idx){
  return `
  <div class="cardbox">
    <div class="cardbox-head">
      <b>Sertifika #${idx+1}</b>
      <div class="row">
        <button class="mini-btn" data-act="del">Sil</button>
      </div>
    </div>
    <div class="grid2">
      <div class="field"><label>BaÅŸlÄ±k</label><input data-k="title" value="${safe(item.title||"")}"></div>
      <div class="field"><label>Veren</label><input data-k="issuer" value="${safe(item.issuer||"")}"></div>
    </div>
    <div class="grid2">
      <div class="field"><label>YÄ±l</label><input data-k="year" value="${safe(item.year||"")}"></div>
      <div class="field"><label>Link (ops.)</label><input data-k="link" value="${safe(item.link||"")}"></div>
    </div>
  </div>`;
}
function rebuildCertUI(){
  const wrap=$("certList");
  wrap.innerHTML = state.certs.map(certTemplate).join("") || `<div class="tiny">HenÃ¼z sertifika eklenmedi.</div>`;
  wrap.querySelectorAll(".cardbox").forEach((box,idx)=>{
    box.querySelectorAll("input").forEach(el=>{
      el.addEventListener("input", ()=>{
        state.certs[idx][el.dataset.k]=el.value; scheduleSave(); renderAll();
      });
    });
    box.querySelector('[data-act="del"]')?.addEventListener("click", ()=>{
      state.certs.splice(idx,1); scheduleSave(); rebuildCertUI(); renderAll();
    });
  });
}

function refTemplate(item, idx){
  return `
  <div class="cardbox">
    <div class="cardbox-head">
      <b>Referans #${idx+1}</b>
      <div class="row">
        <button class="mini-btn" data-act="ai">ğŸ¤– AI</button>
        <button class="mini-btn" data-act="del">Sil</button>
      </div>
    </div>
    <div class="grid2">
      <div class="field"><label>Ad Soyad</label><input data-k="name" value="${safe(item.name||"")}"></div>
      <div class="field"><label>Pozisyon</label><input data-k="role" value="${safe(item.role||"")}"></div>
    </div>
    <div class="grid2">
      <div class="field"><label>Ä°liÅŸki</label><input data-k="relation" value="${safe(item.relation||"")}"></div>
      <div class="field"><label>DÃ¶nem</label><input data-k="period" value="${safe(item.period||"")}"></div>
    </div>
    <div class="field"><label>Odak</label><textarea data-k="focus">${safe(item.focus||"")}</textarea></div>
  </div>`;
}
function rebuildRefUI(){
  const wrap=$("refList");
  wrap.innerHTML = state.refs.map(refTemplate).join("") || `<div class="tiny">HenÃ¼z referans eklenmedi.</div>`;
  wrap.querySelectorAll(".cardbox").forEach((box,idx)=>{
    box.querySelectorAll("input,textarea").forEach(el=>{
      el.addEventListener("input", ()=>{
        state.refs[idx][el.dataset.k]=el.value; scheduleSave(); renderAll();
      });
    });
    box.querySelector('[data-act="del"]')?.addEventListener("click", ()=>{
      state.refs.splice(idx,1); scheduleSave(); rebuildRefUI(); renderAll();
    });
    box.querySelector('[data-act="ai"]')?.addEventListener("click", ()=>{
      if(!state.refs[idx].focus){
        state.refs[idx].focus = "SÄ±nÄ±f iÃ§i uygulamalar, ekip Ã§alÄ±ÅŸmasÄ±, iletiÅŸim ve planlama disiplinim hakkÄ±nda referans verebilir.";
      }
      scheduleSave(); rebuildRefUI(); renderAll();
      aiLog(`Referans #${idx+1} iÃ§in AI odak metni eklendi.`);
    });
  });
}

/* ========= Certificates library (IB/PYP) ========= */
const IB_PYP_CERTS = [
  ["IB Educator Certificates (IBEC) â€“ PYP","IB"],
  ["PYP Category 1 (Making the PYP Happen)","IB"],
  ["PYP Category 2 (Specialist / Classroom)","IB"],
  ["PYP Category 3 (Leadership)","IB"],
  ["PYP Workshop: Assessment in the PYP","IB"],
  ["PYP Workshop: Agency / Student Voice","IB"],
  ["PYP Workshop: ATL Skills","IB"],
  ["PYP Workshop: Transdisciplinary Learning","IB"],
  ["PYP Workshop: Inquiry-Based Learning","IB"],
  ["IB Approaches to Teaching and Learning (ATL)","IB"],
  ["IB Learner Profile & International Mindedness","IB"],
  ["Safeguarding / Child Protection Training","Genel"],
  ["First Aid (Ä°lk YardÄ±m)","Genel"],
  ["Google Certified Educator","Google"],
  ["Apple Teacher","Apple"],
  ["Cambridge TKT / CELTA / TEFL (dil/Ã¶ÄŸretim)","Dil"]
];
function buildCertLibrary(){
  $("certLibrary").innerHTML = IB_PYP_CERTS.map((c,i)=>`<option value="${i}">${c[0]} Â· ${c[1]}</option>`).join("");
}

/* ========= AI (rule-based) ========= */
function frameworksText(){
  const f=state.seo.frameworks;
  const arr=[];
  if(f.pyp) arr.push("PYP");
  if(f.ubd) arr.push("UbD");
  if(f.sel) arr.push("SEL");
  if(f.stem) arr.push("STEM");
  if(f.meb) arr.push("MEB");
  return arr.length?arr.join(", "):"Ã§aÄŸdaÅŸ Ã¶ÄŸretim yaklaÅŸÄ±mlarÄ±";
}
function aiLog(msg){
  const line = `[${new Date().toLocaleString()}] ${msg}`;
  state.ai.log = (state.ai.log ? state.ai.log + "\n" : "") + line;
  $("aiLog").value = state.ai.log;
  scheduleSave();
}
function aiFillHighlight(){
  const role = state.profile.role || "Ã¶ÄŸretmen";
  const fw = frameworksText();
  state.profile.highlight = `${role} olarak Ã¶ÄŸrencilerin merakÄ±nÄ± canlÄ± tutan, ${fw} odaklÄ± ve Ã¶lÃ§me-deÄŸerlendirme kanÄ±tlarÄ±yla desteklenen Ã¶ÄŸrenme deneyimleri tasarlÄ±yorum.`;
  $("inHighlight").value = state.profile.highlight;
  aiLog("Highlight AI ile oluÅŸturuldu.");
}
function aiSuggestKeywords(){
  const base=[];
  const f=state.seo.frameworks;
  if(f.pyp){ base.push("IB PYP","inquiry-based learning","student agency","unit of inquiry","transdisciplinary learning"); }
  if(f.ubd){ base.push("UbD","backward design","learning evidence","assessment alignment"); }
  if(f.sel){ base.push("SEL","classroom climate","relationship-based management"); }
  if(f.stem){ base.push("STEM projects","design thinking"); }
  if(f.meb){ base.push("MEB kazanÄ±mlarÄ±","mÃ¼fredat uyumu"); }
  // profession-based
  const p = state.profession;
  if(p==="Doktor") base.push("patient safety","clinical communication","evidence-based practice");
  if(p==="Avukat") base.push("case management","legal research","client communication");
  if(p==="YazÄ±lÄ±mcÄ±") base.push("clean code","system design","testing","CI/CD");
  const uniq=[...new Set(base)].slice(0,18);
  state.seo.keywords = uniq;
  $("inKeywords").value = uniq.join("\n");
  aiLog("SEO anahtar kelimeler AI ile Ã¶nerildi.");
}
function aiCardFill(which){
  const f=state.seo.frameworks;
  const kws=(state.seo.keywords||[]).slice(0,6);
  const p=state.profession;
  const sp=state.specialty || "";
  const c=state.cards[which];
  if(which==="c1"){
    c.lines = p==="Ã–ÄŸretmen"
      ? ["SÄ±nÄ±f iÃ§i Ã¶ÄŸrenme tasarÄ±mÄ±","Ã–lÃ§me-deÄŸerlendirme kanÄ±tlarÄ±","Veli iletiÅŸimi ve iÅŸbirliÄŸi","FarklÄ±laÅŸtÄ±rma ve kapsayÄ±cÄ±lÄ±k"]
      : ["UzmanlÄ±k alanÄ± odaklÄ± Ã§alÄ±ÅŸmalar","SÃ¼reÃ§/kalite takibi","Ä°letiÅŸim ve koordinasyon","SÃ¼rekli geliÅŸim"];
    if(sp && sp!=="DiÄŸer") c.lines.unshift(sp);
    if(kws.length) c.lines.push("Anahtar: "+kws.join(" Â· "));
  } else if(which==="c2"){
    c.lines = [];
    if(f.pyp) c.lines.push("Inquiry dÃ¶ngÃ¼sÃ¼ ile merakâ€“araÅŸtÄ±rmaâ€“yansÄ±tma");
    if(f.ubd) c.lines.push("Hedefâ€“kanÄ±tâ€“Ã¶ÄŸrenme deneyimi uyumu (UbD)");
    if(f.sel) c.lines.push("GÃ¼venli sÄ±nÄ±f iklimi, rutinler ve Ã¶z dÃ¼zenleme");
    if(!c.lines.length) c.lines.push("Ã–ÄŸrenci/katÄ±lÄ±mcÄ± merkezli yaklaÅŸÄ±m, dÃ¼zenli geri bildirim");
    c.lines.push("BaÄŸlam: "+frameworksText());
  } else if(which==="c3"){
    c.lines = ["Ä°letiÅŸim ve ekip Ã§alÄ±ÅŸmasÄ±","Zaman yÃ¶netimi ve planlama","Veriyle karar alma","Sorumluluk ve tutarlÄ±lÄ±k"];
    if(p==="Ã–ÄŸretmen") c.lines.unshift("Pozitif sÄ±nÄ±f yÃ¶netimi","Ã–ÄŸrenci ajansÄ± ve motivasyon");
  } else if(which==="c4"){
    c.lines = [];
    if(p==="Ã–ÄŸretmen"){
      if(f.pyp) c.lines.push("PYP Category 1â€“2â€“3 atÃ¶lyeleri / IBEC");
      c.lines.push("SÄ±nÄ±f yÃ¶netimi, Ã¶lÃ§me-deÄŸerlendirme eÄŸitimleri","Okul iÃ§i PD paylaÅŸÄ±mlarÄ±");
    } else {
      c.lines.push("Mesleki eÄŸitimler ve sertifikalar","Workshop/seminer katÄ±lÄ±mlarÄ±");
    }
  }
  aiLog(`Kart ${which.toUpperCase()} AI ile dolduruldu.`);
}
function aiAllCards(){
  ["c1","c2","c3","c4"].forEach(aiCardFill);
}
function aiEssay(){
  const type = state.essay.type;
  const typeLabel = type==="teaching"?"teaching philosophy":type==="cover"?"cover letter":"niyet mektubu";
  const target = state.essay.target || "baÅŸvurduÄŸum kurum";
  const fw = frameworksText();
  const seo = (state.seo.keywords||[]).slice(0,7);
  const seoText = seo.length ? `Metinde ${seo.join(", ")} gibi kavramlara yer veriyorum.` : "";
  const p1 = `Ã–ÄŸretim/Ã§alÄ±ÅŸma anlayÄ±ÅŸÄ±mÄ±n merkezinde net hedefler, Ã¶lÃ§Ã¼lebilir kanÄ±tlar ve Ã¶ÄŸrenme sÃ¼recinde gÃ¼venli bir iklim oluÅŸturmak var. ${target} iÃ§in ${typeLabel} niteliÄŸinde, gÃ¼Ã§lÃ¼ bir katkÄ± sunmayÄ± hedefliyorum.`;
  const p2 = `Planlama yaparken ${fw} yaklaÅŸÄ±mÄ±ndan yararlanÄ±yor; hedefâ€“kanÄ±tâ€“uygulama uyumunu koruyorum. ${seoText}`;
  const p3 = `Ekip Ã§alÄ±ÅŸmasÄ±, dÃ¼zenli iletiÅŸim ve sÃ¼rekli geliÅŸim benim iÃ§in vazgeÃ§ilmez. SÃ¼reÃ§ odaklÄ±, sÃ¼rdÃ¼rÃ¼lebilir ve sonuÃ§ Ã¼reten bir Ã§alÄ±ÅŸma disipliniyle ilerliyorum.`;
  state.essay.text = [p1,p2,p3].join("\n\n");
  $("essayText").value = state.essay.text;
  aiLog("Essay AI ile oluÅŸturuldu.");
}
function aiCvComment(){
  const name = state.profile.name || "Aday";
  const years = estimateYears();
  const p = state.profession;
  const fw = frameworksText();
  const certCount = state.certs.length;
  const strengths = state.cards.c3.lines.slice(0,3).join(", ");
  const s = `${name}, ${p} alanÄ±nda${years?` yaklaÅŸÄ±k ${years} yÄ±llÄ±k deneyim izlenimi veren`:""} bir profil sunuyor. ${fw} odaÄŸÄ± ve ${certCount} sertifika kaydÄ±, profesyonel geliÅŸimi destekliyor. Ã–ne Ã§Ä±kan gÃ¼Ã§lÃ¼ yÃ¶nler: ${strengths}. BaÅŸvurulacak kuruma gÃ¶re (Ã¶r. hedef okul/rol), deneyim bulletâ€™larÄ±nÄ± â€œsonuÃ§/etkiâ€ cÃ¼mleleriyle gÃ¼Ã§lendirmek profili daha da parlatÄ±r.`;
  state.ai.comment = s;
  $("cvAiComment").textContent = s;
  aiLog("AI CV yorumu Ã¼retildi.");
  renderAIComment();
  scheduleSave();
}
function estimateYears(){
  // naive from experience dates like 2019â€“2024
  let years=0;
  (state.exp||[]).forEach(e=>{
    const m=(e.dates||"").match(/(19|20)\d{2}/g);
    if(m && m.length>=2){
      const a=parseInt(m[0],10), b=parseInt(m[m.length-1],10);
      if(b>=a) years += Math.max(0, b-a);
    }
  });
  return years || 0;
}
function runAutopilot(){
  // minimal: fill missing parts
  if(!state.profile.highlight) aiFillHighlight();
  if(!state.seo.keywords || !state.seo.keywords.length) aiSuggestKeywords();
  aiAllCards();
  if(state.profession==="Ã–ÄŸretmen" && state.certs.length===0){
    // add 2 default
    state.certs.push({title:"PYP Category 1 (Making the PYP Happen)", issuer:"IB", year:""});
    state.certs.push({title:"Safeguarding / Child Protection Training", issuer:"", year:""});
    rebuildCertUI();
    aiLog("Otopilot: VarsayÄ±lan sertifikalar eklendi.");
  }
  aiCvComment();
  renderAll();
  scheduleSave();
  toast("Otopilot tamamlandÄ±");
}

/* ========= QR generation (no external libs) =========
   Minimal QR placeholder: We'll create a simple pseudo-QR pattern (NOT real QR) if library missing.
   If you need real QR offline, later we can embed a real QR encoder. For now: URL QR requires CDN or upload.
*/
async function generateQrDataUrl(text){
  // If qrcode library exists, use it; otherwise fallback to simple canvas pattern.
  // Lightweight fallback:
  const size=160;
  const canvas=document.createElement("canvas");
  canvas.width=size; canvas.height=size;
  const ctx=canvas.getContext("2d");
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,size,size);
  // pseudo pattern based on hash
  let h=0; for(let i=0;i<text.length;i++){ h=(h*31 + text.charCodeAt(i))>>>0; }
  const cells=25, cell=Math.floor(size/cells);
  for(let y=0;y<cells;y++){
    for(let x=0;x<cells;x++){
      const v = (h + x*131 + y*977) & 1;
      if(v){
        ctx.fillStyle="#111827";
        ctx.fillRect(x*cell,y*cell,cell,cell);
      }
    }
  }
  // finder-like corners
  function finder(px,py){
    ctx.fillStyle="#111827"; ctx.fillRect(px,py,7*cell,7*cell);
    ctx.fillStyle="#fff"; ctx.fillRect(px+cell,py+cell,5*cell,5*cell);
    ctx.fillStyle="#111827"; ctx.fillRect(px+2*cell,py+2*cell,3*cell,3*cell);
  }
  finder(0,0); finder((cells-7)*cell,0); finder(0,(cells-7)*cell);
  return canvas.toDataURL("image/png");
}

/* ========= feedback / scanner ========= */
function appendFeedback(line){
  state.feedback.log = (state.feedback.log? state.feedback.log+"\n":"") + line;
  $("fbLog").value = state.feedback.log;
  scheduleSave();
  localStorage.setItem(LOG_KEY, state.feedback.log);
}
function loadFeedback(){
  const raw = localStorage.getItem(LOG_KEY);
  if(raw){ state.feedback.log = raw; $("fbLog").value = raw; }
}
function scanIssues(){
  const issues=[];
  if(!state.profile.name.trim()) issues.push("Profil: Ad Soyad boÅŸ.");
  if(state.contact.email && !/^\S+@\S+\.\S+$/.test(state.contact.email)) issues.push("Ä°letiÅŸim: E-posta formatÄ± ÅŸÃ¼pheli.");
  const c = COUNTRIES.find(x=>x.code===state.contact.country) || COUNTRIES[0];
  const d=digitsOnly(state.contact.phone);
  if(state.contact.country==="TR"){
    const dd = d.startsWith("90")? d.slice(2): (d.startsWith("0")? d.slice(1):d);
    if(dd && dd.length!==10) issues.push("Telefon: TR iÃ§in 10 hane olmalÄ± (5xx...).");
  } else if(d && d.length < 7) issues.push("Telefon: Ã‡ok kÄ±sa gÃ¶rÃ¼nÃ¼yor.");
  if(!state.seo.keywords.length) issues.push("SEO: Anahtar kelime yok.");
  if(state.profession==="Ã–ÄŸretmen" && state.seo.frameworks.pyp && !state.certs.length) issues.push("Sertifika: PYP seÃ§ili ama sertifika eklenmemiÅŸ.");
  return issues;
}
function smartFixHints(){
  const issues=scanIssues();
  if(!issues.length){ appendFeedback(`[${new Date().toLocaleString()}] âœ… Hata bulunamadÄ±.`); toast("Hata bulunamadÄ±"); return; }
  appendFeedback(`[${new Date().toLocaleString()}] ğŸ” Tarama: ${issues.length} bulgu`);
  issues.forEach(i=>appendFeedback(" - "+i));
  // suggestions
  const sug=[];
  if(issues.some(x=>x.includes("Ad Soyad"))) sug.push("Profil sekmesinde Ad Soyad gir. Bu tÃ¼m CVâ€™ye yansÄ±r.");
  if(issues.some(x=>x.includes("SEO"))) sug.push("Ã‡erÃ§eve/SEO sekmesinde AI ile Ã¶ner deyip chipâ€™lere uygula.");
  if(issues.some(x=>x.includes("Sertifika"))) sug.push("Sertifikalar sekmesinde kÃ¼tÃ¼phaneden PYP Category 1â€“2â€“3 ekle.");
  if(sug.length){
    appendFeedback("Ã–neri:");
    sug.forEach(s=>appendFeedback(" â€¢ "+s));
  }
  toast("Tarama tamamlandÄ±");
}

/* ========= import/export ========= */
function exportJson(){
  const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="akilli_cv_yedek.json"; document.body.appendChild(a); a.click();
  setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);},0);
}
function importJsonFile(){
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange=async ()=> {
    const f=inp.files && inp.files[0]; if(!f) return;
    const txt=await f.text();
    try{
      const obj=JSON.parse(txt);
      state = Object.assign(state, obj);
      hydrateUI();
      rebuildAllLists();
      renderAll();
      scheduleSave();
      toast("Yedek yÃ¼klendi");
    }catch(e){ toast("JSON okunamadÄ±"); }
  };
  inp.click();
}

/* ========= export formats (PDF/Word/PPTX/PNG/JPG/SVG) ========= */
function downloadBlob(filename, blob){
  const a=document.createElement("a");
  const url=URL.createObjectURL(blob);
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 250);
}
function downloadText(filename, text, mime="text/plain"){
  downloadBlob(filename, new Blob([text], {type:mime}));
}
function ensureScript(url, testFn){
  return new Promise((resolve,reject)=>{
    try{ if(testFn()) return resolve(); }catch(e){}
    const s=document.createElement("script");
    s.src=url; s.async=true;
    s.onload=()=>{ try{ if(testFn()) resolve(); else reject(new Error("YÃ¼klendi ama doÄŸrulanamadÄ±")); }catch(e){ reject(e);} };
    s.onerror=()=>reject(new Error("Script yÃ¼klenemedi: "+url));
    document.head.appendChild(s);
  });
}
function getCvHTML(){
  const el=$("cvPreview");
  // Clone so we don't export transient UI
  const clone=el.cloneNode(true);
  // Ensure links have absolute-looking style
  return clone.outerHTML;
}
function exportWord(){
  const bodyHTML = getCvHTML();
  const doc = `<!doctype html><html><head><meta charset="utf-8">
  <title>CV</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif}
    a{color:#0b57d0}
  </style>
  </head><body>${bodyHTML}</body></html>`;
  // Word opens HTML saved as .doc
  downloadText((state.profile.name||"CV").replace(/[^\w\- ]/g,"").trim()||"CV" + ".doc", doc, "application/msword");
}
async function exportImage(kind){
  // Lazy-load html2canvas only if needed
  await ensureScript("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js", ()=>window.html2canvas);
  const el=$("cvPreview");
  const canvas = await window.html2canvas(el, {scale:2, backgroundColor:null, useCORS:true});
  const mime = (kind==="jpg") ? "image/jpeg" : "image/png";
  const ext = (kind==="jpg") ? "jpg" : "png";
  return new Promise(resolve=>{
    canvas.toBlob(blob=>{
      downloadBlob(((state.profile.name||"CV").replace(/[^\w\- ]/g,"").trim()||"CV") + "." + ext, blob);
      resolve();
    }, mime, 0.92);
  });
}
function exportSVG(){
  // Experimental: foreignObject-based SVG snapshot
  const w=794, h=1123; // A4 @ 96dpi-ish
  const html = getCvHTML()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
  <foreignObject width="100%" height="100%">
    <div xmlns="http://www.w3.org/1999/xhtml">${html}</div>
  </foreignObject>
</svg>`;
  downloadText(((state.profile.name||"CV").replace(/[^\w\- ]/g,"").trim()||"CV") + ".svg", svg, "image/svg+xml");
}
async function exportPPTX(){
  // Create a simple 1-slide PPTX with a screenshot of the CV (works well for sharing)
  await ensureScript("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js", ()=>window.html2canvas);
  await ensureScript("https://cdn.jsdelivr.net/npm/pptxgenjs@3.11.0/dist/pptxgen.bundle.js", ()=>window.PptxGenJS || window.PptxGen);
  const el=$("cvPreview");
  const canvas = await window.html2canvas(el, {scale:2, backgroundColor:"#ffffff", useCORS:true});
  const dataUrl = canvas.toDataURL("image/png");
  const pptx = new (window.PptxGenJS||window.PptxGen)();
  pptx.layout = "LAYOUT_WIDE";
  const slide = pptx.addSlide();
  // Fit image into slide
  slide.addImage({ data: dataUrl, x:0.3, y:0.3, w:12.7, h:7.1 });
  const out = await pptx.write("blob");
  downloadBlob(((state.profile.name||"CV").replace(/[^\w\- ]/g,"").trim()||"CV") + ".pptx", out);
}
function exportPDF(){
  // Uses the built-in print dialog (Save as PDF)
  window.print();
}



/* ========= hydrate UI from state ========= */
function hydrateUI(){
  // Start
  $("professionSelect").value = state.profession || "Ã–ÄŸretmen";
  rebuildSpecialties();
  $("specialtySelect").value = state.specialty || $("specialtySelect").value;
  $("professionCustom").value = state.professionCustom || "";
  $("goalSelect").value = state.goal || "job";
  $("showReferences").checked = !!state.show.refs;
  $("showEssay").checked = !!state.show.essay;
  $("showAiComment").checked = !!state.show.aiComment;

  // Profile
  $("inName").value = state.profile.name || "";
  $("inRole").value = state.profile.role || "";
  $("inHighlight").value = state.profile.highlight || "";

  // Contact
  $("inEmail").value = state.contact.email || "";
  $("inLink").value = state.contact.link || "";
  $("countrySelect").value = state.contact.country || "TR";
  phoneMaxForCountry($("countrySelect").value);
  $("inPhone").value = state.contact.phone || "";
  $("citySelect").value = state.contact.city || "Ä°stanbul (Avrupa)";
  $("inDistrict").value = state.contact.district || "";
  $("inQrUrl").value = state.contact.qrUrl || "";
  $("inQrLabel").value = state.contact.qrLabel || "Online CV / Portfolyo";
  $("inLastUpdate").value = state.contact.lastUpdate || "";
  $("inDeclaration").value = state.contact.declaration || "Bu CVâ€™de yer alan bilgilerin doÄŸru ve gÃ¼ncel olduÄŸunu beyan ederim.";

  // SEO
  $("fwPYP").checked = !!state.seo.frameworks.pyp;
  $("fwUbD").checked = !!state.seo.frameworks.ubd;
  $("fwSEL").checked = !!state.seo.frameworks.sel;
  $("fwSTEM").checked = !!state.seo.frameworks.stem;
  $("fwMEB").checked = !!state.seo.frameworks.meb;
  $("inKeywords").value = (state.seo.keywords||[]).join("\n");

  // Cards
  ["c1","c2","c3","c4"].forEach(k=>{
    $(k==="c1"?"c1Show":k==="c2"?"c2Show":k==="c3"?"c3Show":"c4Show").checked = !!state.cards[k].show;
    $(k==="c1"?"c1Title":k==="c2"?"c2Title":k==="c3"?"c3Title":"c4Title").value = state.cards[k].title || "";
    $(k==="c1"?"c1Lines":k==="c2"?"c2Lines":k==="c3"?"c3Lines":"c4Lines").value = (state.cards[k].lines||[]).join("\n");
  });

  // Essay
  $("essayType").value = state.essay.type || "motivation";
  $("essayTitle").value = state.essay.title || "";
  $("essayTarget").value = state.essay.target || "";
  $("essayText").value = state.essay.text || "";

  // AI panel
  $("aiGuide").value = state.ai.guide || "";
  $("aiLog").value = state.ai.log || "";
}
function rebuildAllLists(){
  rebuildEduUI();
  rebuildExpUI();
  rebuildCertUI();
  rebuildRefUI();
}

/* ========= Wire events ========= */
function wire(){
  // Tabs
  $("tabs").addEventListener("click",(e)=>{
    const btn=e.target.closest(".tab");
    if(!btn) return;
    setTab(btn.dataset.tab);
  });

  // Panel open/close
  $("btnOpenPanel").addEventListener("click", ()=>openPanel(true));
  $("btnClosePanel").addEventListener("click", ()=>openPanel(false));
  $("overlay").addEventListener("click", ()=>openPanel(false));

  // A4 modal
  $("btnA4").addEventListener("click", ()=>{
    const holder=$("a4Holder");
    holder.innerHTML="";
    // clone paper
    const clone=$("paper").cloneNode(true);
    clone.style.margin="0 auto";
    holder.appendChild(clone);
    $("a4Modal").classList.add("open");
  });
  $("btnModalClose").addEventListener("click", ()=>$("a4Modal").classList.remove("open"));
  $("a4Modal").addEventListener("click",(e)=>{ if(e.target.id==="a4Modal") $("a4Modal").classList.remove("open"); });
  $("btnPrint").addEventListener("click", ()=>window.print());

  // Export menu (PDF/Word/PPTX/PNG/JPG/SVG/JSON)
  const exportBtn = $("btnExportMenu");
  const exportMenu = $("exportMenu");
  exportBtn.addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    exportMenu.classList.toggle("open");
    exportBtn.setAttribute("aria-expanded", exportMenu.classList.contains("open") ? "true" : "false");
  });
  document.addEventListener("click", ()=>{
    exportMenu.classList.remove("open");
    exportBtn.setAttribute("aria-expanded","false");
  });
  exportMenu.addEventListener("click", async (e)=>{
    const btn = e.target.closest(".menu-item");
    if(!btn) return;
    const kind = btn.dataset.export;
    exportMenu.classList.remove("open");
    exportBtn.setAttribute("aria-expanded","false");
    try{
      if(kind==="pdf") exportPDF();
      else if(kind==="word") exportWord();
      else if(kind==="pptx") await exportPPTX();
      else if(kind==="png") await exportImage("png");
      else if(kind==="jpg") await exportImage("jpg");
      else if(kind==="svg") exportSVG();
      else if(kind==="json") exportJson();
    }catch(err){
      console.error(err);
      alert("DÄ±ÅŸa aktarma baÅŸarÄ±sÄ±z: " + (err && err.message ? err.message : err));
    }
  });

  $("btnModalPrint").addEventListener("click", ()=>window.print());

  // Theme buttons
  $("tSystem").addEventListener("click", ()=>{applyTheme("system"); setSegActive(["tSystem","tLight","tDark"],"tSystem");});
  $("tLight").addEventListener("click", ()=>{applyTheme("light"); setSegActive(["tSystem","tLight","tDark"],"tLight");});
  $("tDark").addEventListener("click", ()=>{applyTheme("dark"); setSegActive(["tSystem","tLight","tDark"],"tDark");});

  // Device buttons
  $("dDesk").addEventListener("click", ()=>{applyDevice("desktop"); setSegActive(["dDesk","dMob"],"dDesk");});
  $("dMob").addEventListener("click", ()=>{applyDevice("mobile"); setSegActive(["dDesk","dMob"],"dMob"); openPanel(false);});

  // Start flow
  $("professionSelect").addEventListener("change", ()=>{
    state.profession = $("professionSelect").value;
    rebuildSpecialties();
    state.specialty = $("specialtySelect").value;
    scheduleSave();
    renderAll();
  });
  $("specialtySelect").addEventListener("change", ()=>{
    state.specialty = $("specialtySelect").value;
    scheduleSave(); renderAll();
  });
  $("professionCustom").addEventListener("input", ()=>{
    state.professionCustom = $("professionCustom").value;
    scheduleSave();
  });
  $("goalSelect").addEventListener("change", ()=>{
    state.goal = $("goalSelect").value; scheduleSave();
  });
  $("showReferences").addEventListener("change", ()=>{
    state.show.refs = $("showReferences").checked; scheduleSave(); renderAll();
  });
  $("showEssay").addEventListener("change", ()=>{
    state.show.essay = $("showEssay").checked; scheduleSave(); renderAll();
  });
  $("showAiComment").addEventListener("change", ()=>{
    state.show.aiComment = $("showAiComment").checked; scheduleSave(); renderAll();
  });

  $("btnSmartSetup").addEventListener("click", ()=>{
    // profession-based defaults
    const p=state.profession;
    if(p==="Ã–ÄŸretmen"){
      state.seo.frameworks.pyp=true;
      state.seo.keywords = ["IB PYP","inquiry-based learning","student agency","unit of inquiry","assessment in the PYP","ATL skills"];
      $("fwPYP").checked=true;
      $("inKeywords").value = state.seo.keywords.join("\n");
      aiAllCards();
      if(!state.profile.role) { state.profile.role = "SÄ±nÄ±f Ã–ÄŸretmeni Â· IB PYP"; $("inRole").value=state.profile.role; }
    } else if(p==="Doktor"){
      state.seo.keywords = ["patient safety","clinical communication","evidence-based practice","teamwork","quality improvement"];
      $("inKeywords").value = state.seo.keywords.join("\n");
      aiAllCards();
    } else if(p==="Avukat"){
      state.seo.keywords = ["legal research","case management","client communication","contract drafting","litigation support"];
      $("inKeywords").value = state.seo.keywords.join("\n");
      aiAllCards();
    } else {
      aiSuggestKeywords(); aiAllCards();
    }
    renderAll(); scheduleSave();
    $("startHint").textContent = "AkÄ±llÄ± kurulum tamamlandÄ±. Ä°stersen AI StÃ¼dyo â†’ Otopilot ile tÃ¼mÃ¼nÃ¼ tamamla.";
    toast("AkÄ±llÄ± kurulum");
  });
  $("btnSmartSeo").addEventListener("click", ()=>{ aiSuggestKeywords(); renderChips(); scheduleSave(); });
  $("btnSmartCert").addEventListener("click", ()=>{
    if(state.profession==="Ã–ÄŸretmen"){
      appendFeedback(`[${new Date().toLocaleString()}] ğŸ“ Ã–neri: PYP Category 1â€“2â€“3, IBEC, Safeguarding, First Aid, Google Educator.`);
      toast("Sertifika Ã¶nerildi");
    } else {
      appendFeedback(`[${new Date().toLocaleString()}] ğŸ“ Ã–neri: MesleÄŸine gÃ¶re temel sertifikalarÄ± ekle (kalite, gÃ¼venlik, iletiÅŸim).`);
      toast("Sertifika Ã¶nerildi");
    }
  });

  // Profile inputs
  ["inName","inRole","inHighlight"].forEach(id=>{
    $(id).addEventListener("input", ()=>{
      state.profile.name = $("inName").value;
      state.profile.role = $("inRole").value;
      state.profile.highlight = $("inHighlight").value;
      scheduleSave(); renderAll();
    });
  });
  $("aiHighlightBtn").addEventListener("click", ()=>{ aiFillHighlight(); scheduleSave(); renderAll(); });
  $("btnClearPhoto").addEventListener("click", ()=>{
    state.profile.photoData=""; $("inPhoto").value=""; scheduleSave(); renderAll(); toast("FotoÄŸraf temizlendi");
  });
  $("inPhoto").addEventListener("change", (e)=>{
    const f=e.target.files && e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ state.profile.photoData=r.result; scheduleSave(); renderAll(); toast("FotoÄŸraf yÃ¼klendi"); };
    r.readAsDataURL(f);
  });

  // Contact inputs
  $("inEmail").addEventListener("input", ()=>{ state.contact.email=$("inEmail").value; scheduleSave(); renderAll(); });
  $("inLink").addEventListener("input", ()=>{ state.contact.link=$("inLink").value; scheduleSave(); renderAll(); });

  $("countrySelect").addEventListener("change", ()=>{
    state.contact.country = $("countrySelect").value;
    phoneMaxForCountry(state.contact.country);
    // reformat current number safely
    state.contact.phone = formatPhone(state.contact.country, $("inPhone").value);
    $("inPhone").value = state.contact.phone;
    scheduleSave(); renderAll();
  });
  // phone: avoid "+90+90" by always formatting from digits
  const phoneHandler = ()=>{
    const code = state.contact.country;
    const formatted = formatPhone(code, $("inPhone").value);
    state.contact.phone = formatted;
    $("inPhone").value = formatted;
    scheduleSave(); renderAll();
  };
  $("inPhone").addEventListener("blur", phoneHandler);
  $("inPhone").addEventListener("input", ()=>{
    // do not aggressively format on each keystroke for non-TR; but TR needs helpful formatting.
    if(state.contact.country==="TR") phoneHandler();
    else { state.contact.phone = $("inPhone").value; scheduleSave(); renderAll(); }
  });

  $("citySelect").addEventListener("change", ()=>{ state.contact.city=$("citySelect").value; scheduleSave(); renderAll(); });
  $("inDistrict").addEventListener("input", ()=>{ state.contact.district=$("inDistrict").value; scheduleSave(); renderAll(); });

  $("inQrUrl").addEventListener("input", ()=>{ state.contact.qrUrl=$("inQrUrl").value; scheduleSave(); });
  $("inQrLabel").addEventListener("input", ()=>{ state.contact.qrLabel=$("inQrLabel").value; scheduleSave(); renderAll(); });

  $("btnGenQr").addEventListener("click", async ()=>{
    const url=$("inQrUrl").value.trim();
    if(!url){ toast("Ã–nce URL gir"); return; }
    state.contact.qrUrl=url;
    state.contact.qrImg="";
    state.contact.qrData = await generateQrDataUrl(url);
    scheduleSave(); renderAll();
    toast("QR oluÅŸturuldu");
  });
  $("btnClearQr").addEventListener("click", ()=>{
    state.contact.qrImg=""; state.contact.qrData=""; $("inQrImg").value="";
    scheduleSave(); renderAll(); toast("QR temizlendi");
  });
  $("inQrImg").addEventListener("change", (e)=>{
    const f=e.target.files && e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ state.contact.qrImg=r.result; state.contact.qrData=""; scheduleSave(); renderAll(); toast("QR gÃ¶rsel yÃ¼klendi"); };
    r.readAsDataURL(f);
  });

  $("btnSetNow").addEventListener("click", ()=>{
    state.contact.lastUpdate = nowMMYYYY();
    $("inLastUpdate").value = state.contact.lastUpdate;
    scheduleSave(); renderAll();
  });
  $("inLastUpdate").addEventListener("input", ()=>{ state.contact.lastUpdate=$("inLastUpdate").value; scheduleSave(); renderAll(); });
  $("inDeclaration").addEventListener("input", ()=>{ state.contact.declaration=$("inDeclaration").value; scheduleSave(); renderAll(); });

  // SEO
  ["fwPYP","fwUbD","fwSEL","fwSTEM","fwMEB"].forEach(id=>{
    $(id).addEventListener("change", ()=>{
      state.seo.frameworks = {
        pyp:$("fwPYP").checked,
        ubd:$("fwUbD").checked,
        sel:$("fwSEL").checked,
        stem:$("fwSTEM").checked,
        meb:$("fwMEB").checked
      };
      scheduleSave();
    });
  });
  $("aiKeywordsBtn").addEventListener("click", ()=>{ aiSuggestKeywords(); renderAll(); scheduleSave(); });
  $("btnApplyKeywords").addEventListener("click", ()=>{
    state.seo.keywords = lines($("inKeywords").value);
    scheduleSave(); renderAll(); toast("UygulandÄ±");
  });
  $("inKeywords").addEventListener("input", ()=>{ state.seo.keywords = lines($("inKeywords").value); scheduleSave(); renderAll(); });

  // Cards
  function bindCard(k, showId, titleId, linesId, aiId){
    $(showId).addEventListener("change", ()=>{
      state.cards[k].show = $(showId).checked; scheduleSave(); renderAll();
    });
    $(titleId).addEventListener("input", ()=>{
      state.cards[k].title = $(titleId).value; scheduleSave(); renderAll();
    });
    $(linesId).addEventListener("input", ()=>{
      state.cards[k].lines = lines($(linesId).value); scheduleSave(); renderAll();
    });
    $(aiId).addEventListener("click", ()=>{
      aiCardFill(k); 
      $(linesId).value = state.cards[k].lines.join("\n");
      scheduleSave(); renderAll();
    });
  }
  bindCard("c1","c1Show","c1Title","c1Lines","aiCard1");
  bindCard("c2","c2Show","c2Title","c2Lines","aiCard2");
  bindCard("c3","c3Show","c3Title","c3Lines","aiCard3");
  bindCard("c4","c4Show","c4Title","c4Lines","aiCard4");
  $("aiAllCards").addEventListener("click", ()=>{
    aiAllCards();
    $("c1Lines").value = state.cards.c1.lines.join("\n");
    $("c2Lines").value = state.cards.c2.lines.join("\n");
    $("c3Lines").value = state.cards.c3.lines.join("\n");
    $("c4Lines").value = state.cards.c4.lines.join("\n");
    scheduleSave(); renderAll();
  });

  // EDU/EXP/REF add
  $("btnAddEdu").addEventListener("click", ()=>{
    state.edu.push({degree:"",program:"",school:"",location:"",dates:"",notes:""});
    rebuildEduUI(); scheduleSave(); renderAll();
  });
  $("aiEduAll").addEventListener("click", ()=>{
    state.edu.forEach((e,i)=>{ if(!e.notes) e.notes = `${e.program||"Program"} odaklÄ± temel yetkinlikleri gÃ¼Ã§lendirdim.`; });
    rebuildEduUI(); scheduleSave(); renderAll(); aiLog("TÃ¼m eÄŸitim kartlarÄ±na AI dokunuÅŸ yapÄ±ldÄ±.");
  });

  $("btnAddExp").addEventListener("click", ()=>{
    state.exp.push({org:"",role:"",location:"",dates:"",tags:[],bullets:[]});
    rebuildExpUI(); scheduleSave(); renderAll();
  });
  $("aiExpAll").addEventListener("click", ()=>{
    state.exp.forEach((e,i)=>{
      if(!e.bullets || !e.bullets.length){
        e.bullets = ["SÃ¼reÃ§leri planladÄ±m ve takip ettim.","Ekip iletiÅŸimini gÃ¼Ã§lendirdim.","SonuÃ§ odaklÄ± iyileÅŸtirmeler yaptÄ±m."];
      }
    });
    rebuildExpUI(); scheduleSave(); renderAll(); aiLog("TÃ¼m deneyim kartlarÄ±na AI bullet Ã¶nerildi.");
  });

  $("btnAddRef").addEventListener("click", ()=>{
    state.refs.push({name:"",role:"",relation:"",period:"",focus:""});
    rebuildRefUI(); scheduleSave(); renderAll();
  });
  $("aiRefAll").addEventListener("click", ()=>{
    state.refs.forEach(r=>{ if(!r.focus) r.focus="Ä°letiÅŸim, iÅŸ disiplini ve sonuÃ§ Ã¼retme kapasitem hakkÄ±nda referans verebilir."; });
    rebuildRefUI(); scheduleSave(); renderAll(); aiLog("TÃ¼m referanslara AI odak metni eklendi.");
  });

  // CERT add
  $("btnAddCert").addEventListener("click", ()=>{
    state.certs.push({title:"",issuer:"",year:"",link:""});
    rebuildCertUI(); scheduleSave(); renderAll();
  });
  $("btnAddCertFromLib").addEventListener("click", ()=>{
    const idx = parseInt($("certLibrary").value,10);
    const c = IB_PYP_CERTS[idx];
    if(!c) return;
    state.certs.push({title:c[0], issuer:c[1], year:"", link:""});
    rebuildCertUI(); scheduleSave(); renderAll(); toast("Sertifika eklendi");
  });
  $("btnSuggestCert").addEventListener("click", ()=>{
    if(state.profession==="Ã–ÄŸretmen"){
      // auto-add common missing ones (max 3)
      const has = new Set(state.certs.map(x=>x.title));
      const picks = ["PYP Category 1 (Making the PYP Happen)","PYP Category 2 (Specialist / Classroom)","Safeguarding / Child Protection Training"];
      let added=0;
      picks.forEach(t=>{
        const match = IB_PYP_CERTS.find(x=>x[0]===t);
        if(match && !has.has(t) && added<3){
          state.certs.push({title:match[0], issuer:match[1], year:"", link:""});
          added++;
        }
      });
      rebuildCertUI(); scheduleSave(); renderAll();
      aiLog("Sertifika Ã¶nerileri eklendi.");
      toast("Ã–neriler eklendi");
    } else {
      toast("Bu meslek iÃ§in kÃ¼tÃ¼phaneyi geniÅŸletebiliriz.");
    }
  });

  // Essay
  $("essayType").addEventListener("change", ()=>{ state.essay.type=$("essayType").value; scheduleSave(); renderAll(); });
  $("essayTitle").addEventListener("input", ()=>{ state.essay.title=$("essayTitle").value; scheduleSave(); renderAll(); });
  $("essayTarget").addEventListener("input", ()=>{ state.essay.target=$("essayTarget").value; scheduleSave(); renderAll(); });
  $("essayText").addEventListener("input", ()=>{ state.essay.text=$("essayText").value; scheduleSave(); renderAll(); });
  $("aiEssayBtn").addEventListener("click", ()=>{ aiEssay(); scheduleSave(); renderAll(); });
  $("btnClearEssay").addEventListener("click", ()=>{ state.essay.text=""; $("essayText").value=""; scheduleSave(); renderAll(); });

  // AI studio
  $("aiGuide").addEventListener("input", ()=>{ state.ai.guide=$("aiGuide").value; scheduleSave(); });
  $("aiRunAll").addEventListener("click", ()=>{ runAutopilot(); });
  $("aiCvComment").addEventListener("click", ()=>{ aiCvComment(); });

  // Autopilot button
  $("btnAutoPilot").addEventListener("click", ()=>{ runAutopilot(); });

  // Feedback
  $("btnScan").addEventListener("click", ()=>{
    const issues = scanIssues();
    appendFeedback(`[${new Date().toLocaleString()}] ğŸ” Tarama sonucu: ${issues.length?issues.length+" bulgu":"bulgu yok"}`);
    issues.forEach(i=>appendFeedback(" - "+i));
    toast("Tarama tamamlandÄ±");
  });
  $("btnFixHints").addEventListener("click", ()=>smartFixHints());
  $("btnClearLogs").addEventListener("click", ()=>{
    state.feedback.log=""; $("fbLog").value=""; localStorage.removeItem(LOG_KEY);
    toast("Log temizlendi"); scheduleSave();
  });
  $("btnSaveFeedback").addEventListener("click", ()=>{
    const txt=$("fbText").value.trim();
    if(!txt){ toast("Bir ÅŸey yaz"); return; }
    appendFeedback(`[${new Date().toLocaleString()}] ğŸ“ ${txt}`);
    $("fbText").value="";
    toast("Kaydedildi");
  });
  $("btnAiFeedback").addEventListener("click", ()=>{
    const txt=$("fbText").value.trim();
    if(!txt){ toast("Bir ÅŸey yaz"); return; }
    const refined = `Sorun: ${txt}\nBeklenen: (kÄ±sa)\nOlan: (kÄ±sa)\nTekrar adÄ±mÄ±: 1) ... 2) ...\nTarayÄ±cÄ±/cihaz: ...`;
    $("fbText").value = refined;
    toast("AI netleÅŸtirdi (taslak)");
  });

  // Import/export
  $("btnExportJson").addEventListener("click", exportJson);
  $("btnImportJson").addEventListener("click", importJsonFile);
}

/* ========= init ========= */
function init(){
  // build selects
  $("professionSelect").innerHTML = PROFESSIONS.map(p=>`<option value="${p}">${p}</option>`).join("");
  buildCountry(); buildCity(); buildCertLibrary();

  loadState();
ensureExtensions();
  loadFeedback();

  // apply saved theme/device
  const theme = localStorage.getItem("AKILLI_THEME") || "system";
  applyTheme(theme);
  setSegActive(["tSystem","tLight","tDark"], theme==="light"?"tLight": theme==="dark"?"tDark":"tSystem");
  const dev = localStorage.getItem("AKILLI_DEVICE") || "desktop";
  applyDevice(dev);
  setSegActive(["dDesk","dMob"], dev==="mobile"?"dMob":"dDesk");

  hydrateUI();
  rebuildSpecialties();
  rebuildAllLists();
  renderAll();
  wire();

  // ensure panel closed on load on mobile, open on desktop
  if(window.matchMedia("(min-width: 1100px)").matches){
    openPanel(false); // desktop uses static drawer; button still works
  } else {
    openPanel(false);
  }
}


/* ===============================
   PATCH: YÃ¶netim + Son Silinenler + Ã–zel Kart/Patch (v1)
   Bu patch kilitli temayÄ± BOZMADAN ek Ã¶zellikler sunar.
================================ */

function ensureExtensions(){
  state.show = state.show || {};
  // Mevcut anahtarlarÄ± koru, eksikleri tamamla
  const showDefaults = {
    edu: true, exp: true, cert: true,
    refs: (state.show.refs ?? true),
    essay: (state.show.essay ?? true),
    aiComment: (state.show.aiComment ?? true),
    custom: true
  };
  for (const k in showDefaults){
    if (typeof state.show[k] !== "boolean") state.show[k] = showDefaults[k];
  }

  state.titles = state.titles || {};
  const titleDefaults = {
    edu: "EÄŸitim",
    exp: "Deneyim",
    cert: "Sertifikalar",
    refs: "Referanslar",
    essay: "Kariyer PlanÄ± / Hedef",
    aiComment: "AI CV Yorumu"
  };
  for (const k in titleDefaults){
    if (!state.titles[k]) state.titles[k] = titleDefaults[k];
  }

  state.customPatches = Array.isArray(state.customPatches) ? state.customPatches : [];
  state.trash = Array.isArray(state.trash) ? state.trash : [];

  state.ui = state.ui || {};
  if (typeof state.ui.shareMode !== "boolean") state.ui.shareMode = false;
  if (typeof state.ui.redact !== "boolean") state.ui.redact = false;
}

function uid(){
  return (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2) + Date.now());
}

function softDelete(type, idx){
  const map = { edu: state.edu, exp: state.exp, refs: state.refs, custom: state.customPatches };
  const arr = map[type];
  if (!arr || idx<0 || idx>=arr.length) return;
  const item = arr.splice(idx,1)[0];
  state.trash.unshift({ id: uid(), type, idx, item, ts: Date.now() });
  // Limit trash size
  if (state.trash.length > 100) state.trash = state.trash.slice(0,100);
  saveState();
  renderAll();
}

function restoreTrash(trashId){
  const tIdx = state.trash.findIndex(x => x.id === trashId);
  if (tIdx === -1) return;
  const entry = state.trash.splice(tIdx,1)[0];
  const map = { edu: state.edu, exp: state.exp, refs: state.refs, custom: state.customPatches };
  const arr = map[entry.type];
  if (!arr) return;
  const insertAt = Math.min(Math.max(entry.idx ?? arr.length, 0), arr.length);
  arr.splice(insertAt, 0, entry.item);
  saveState();
  renderAll();
}

function purgeTrash(trashId){
  const tIdx = state.trash.findIndex(x => x.id === trashId);
  if (tIdx === -1) return;
  state.trash.splice(tIdx,1);
  saveState();
  renderAll();
}

function clearTrash(){
  state.trash = [];
  saveState();
  renderAll();
}

function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[s]));
}

function nl2br(s){ return escapeHtml(s).replace(/\n/g, "<br>"); }

function applyTitlesAndVisibility(){
  // Titles
  const setText = (id, val) => { const el = $(id); if (el) el.textContent = val; };
  setText("secEduTitle", state.titles.edu);
  setText("secExpTitle", state.titles.exp);
  setText("secCertTitle", state.titles.cert);
  setText("secRefTitle", state.titles.refs);
  setText("secEssayTitle", state.titles.essay);
  setText("secAiTitle", state.titles.aiComment);

  // Visibility
  const show = (id, on) => { const el = $(id); if (el) el.style.display = on ? "" : "none"; };

  // For each section, hide both title + container
  show("secEduTitle", state.show.edu); show("cvEdu", state.show.edu);
  show("secExpTitle", state.show.exp); show("cvExp", state.show.exp);
  show("secCertTitle", state.show.cert); show("cvCerts", state.show.cert);

  show("secRefTitle", state.show.refs); show("cvRefs", state.show.refs);
  show("secEssayTitle", state.show.essay); show("cvEssayCard", state.show.essay);

  show("secAiTitle", state.show.aiComment); show("cvAiCard", state.show.aiComment);

  show("cvCustomSections", state.show.custom);
}

function maskEmail(email){
  email = String(email||"").trim();
  const at = email.indexOf("@");
  if (at<=1) return email ? "â€¢â€¢â€¢@" + email.slice(at+1) : "";
  return email[0] + "â€¢â€¢â€¢" + email.slice(at-1);
}
function maskPhone(phone){
  const d = String(phone||"").replace(/\D/g,"");
  if (!d) return "";
  const tail = d.slice(-2);
  return "â€¢â€¢â€¢ â€¢â€¢ " + tail;
}

function renderCustomSections(){
  const wrap = $("cvCustomSections");
  if (!wrap) return;
  const items = state.customPatches.filter(p => p.kind !== "js" && p.visible !== false);
  if (!items.length){ wrap.innerHTML = ""; return; }

  let html = "";
  for (const p of items){
    if (p.kind === "html"){
      html += `<div class="sec-title">${escapeHtml(p.title||"Ã–zel BÃ¶lÃ¼m")}</div>`;
      html += `<div class="cv-card"><div class="sec-body">${p.body||""}</div></div>`;
    } else {
      html += `<div class="sec-title">${escapeHtml(p.title||"Ã–zel BÃ¶lÃ¼m")}</div>`;
      html += `<div class="cv-card"><div class="sec-body">${nl2br(p.body||"")}</div></div>`;
    }
  }
  wrap.innerHTML = html;
}

function renderTrashUI(){
  const box = $("trashList");
  if (!box) return;
  if (!state.trash.length){
    box.innerHTML = `<div class="subtle">Ã‡Ã¶p kutusu boÅŸ.</div>`;
    return;
  }
  const typeLabel = { edu:"EÄŸitim", exp:"Deneyim", refs:"Referans", custom:"Ã–zel Kart" };
  box.innerHTML = state.trash.slice(0,30).map(t=>{
    const when = new Date(t.ts).toLocaleString();
    const titleGuess = (t.item && (t.item.school || t.item.company || t.item.name || t.item.title)) || "";
    return `
      <div class="card" style="padding:10px; margin:10px 0;">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <div>
            <div style="font-weight:700">${typeLabel[t.type]||t.type} ${titleGuess?("â€¢ "+escapeHtml(titleGuess)):""}</div>
            <div class="subtle">${when}</div>
          </div>
          <div class="row" style="gap:8px; flex-wrap:wrap;">
            <button class="btn" data-act="restoreTrash" data-id="${t.id}">Geri yÃ¼kle</button>
            <button class="btn danger" data-act="purgeTrash" data-id="${t.id}">KalÄ±cÄ± sil</button>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

function renderManageUI(){
  // Titles inputs
  const setVal = (id, v) => { const el = $(id); if (el) el.value = v ?? ""; };
  setVal("titleEdu", state.titles.edu);
  setVal("titleExp", state.titles.exp);
  setVal("titleCert", state.titles.cert);
  setVal("titleRefs", state.titles.refs);
  setVal("titleEssay", state.titles.essay);
  setVal("titleAi", state.titles.aiComment);

  // Show toggles
  const setChk = (id, v) => { const el = $(id); if (el) el.checked = !!v; };
  setChk("showEdu", state.show.edu);
  setChk("showExp", state.show.exp);
  setChk("showCert", state.show.cert);
  setChk("showRefs2", state.show.refs);
  setChk("showEssay2", state.show.essay);
  setChk("showAiComment2", state.show.aiComment);
  setChk("showCustom", state.show.custom);

  setChk("shareMode", state.ui.shareMode);
  setChk("redactMode", state.ui.redact);

  // Custom list
  const list = $("customList");
  if (list){
    if (!state.customPatches.length){
      list.innerHTML = `<div class="subtle">HenÃ¼z Ã¶zel kart/patch eklenmedi.</div>`;
    } else {
      list.innerHTML = state.customPatches.slice().reverse().map(p=>{
        const badge = p.kind === "js" ? "JS" : (p.kind==="html" ? "HTML" : "Kart");
        const vis = (p.visible === false) ? "Gizli" : "AÃ§Ä±k";
        return `
          <div class="card" style="padding:10px; margin:10px 0;">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
              <div>
                <div style="font-weight:800">${escapeHtml(p.title||"Ã–zel BÃ¶lÃ¼m")} <span class="subtle">(${badge} â€¢ ${vis})</span></div>
                <div class="subtle">${new Date(p.ts||Date.now()).toLocaleString()}</div>
              </div>
              <div class="row" style="gap:8px; flex-wrap:wrap;">
                ${p.kind==="js" ? `<button class="btn" data-act="runJsPatch" data-id="${p.id}">Ã‡alÄ±ÅŸtÄ±r</button>` : ``}
                <button class="btn ghost" data-act="togglePatch" data-id="${p.id}">${(p.visible===false)?"GÃ¶ster":"Gizle"}</button>
                <button class="btn danger" data-act="delPatch" data-id="${p.id}">Sil</button>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }
  }

  renderTrashUI();
}

function applyShareMode(){
  document.body.classList.toggle("share-mode", !!state.ui.shareMode);
}

/* Hook: render pipeline */
const __orig_renderAll = renderAll;
renderAll = function(){
  __orig_renderAll();
  ensureExtensions();
  applyTitlesAndVisibility();
  renderCustomSections();
  renderManageUI();
  applyShareMode();
};

/* Hook: redact contact lines */
const __orig_renderHeader = renderHeader;
renderHeader = function(){
  __orig_renderHeader();
  if (!state.ui.redact) return;
  const emailEl = $("cvEmail"); if (emailEl) emailEl.textContent = maskEmail(state.profile.email);
  const phoneEl = $("cvPhone"); if (phoneEl) phoneEl.textContent = maskPhone(state.profile.phone);
};

/* Replace hard deletes with soft deletes */
(function patchDeletes(){
  // We patch the existing delegated click handler by intercepting and re-binding additional behaviors.
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-act]");
    if (!btn) return;
    const act = btn.dataset.act;

    if (act === "restoreTrash"){
      restoreTrash(btn.dataset.id); e.preventDefault(); return;
    }
    if (act === "purgeTrash"){
      purgeTrash(btn.dataset.id); e.preventDefault(); return;
    }
    if (act === "togglePatch"){
      const id = btn.dataset.id;
      const p = state.customPatches.find(x=>x.id===id);
      if (!p) return;
      p.visible = (p.visible===false) ? true : false;
      saveState(); renderAll(); e.preventDefault(); return;
    }
    if (act === "delPatch"){
      const id = btn.dataset.id;
      const i = state.customPatches.findIndex(x=>x.id===id);
      if (i===-1) return;
      softDelete("custom", i);
      e.preventDefault(); return;
    }
    if (act === "runJsPatch"){
      const id = btn.dataset.id;
      const p = state.customPatches.find(x=>x.id===id);
      if (!p || p.kind!=="js") return;
      try{ (new Function(p.body||""))(); toast("JS patch Ã§alÄ±ÅŸtÄ±."); }catch(err){ console.error(err); toast("JS patch hata verdi."); }
      e.preventDefault(); return;
    }
  }, true);
})();

/* Manage tab controls */
(function bindManage(){
  // Save titles
  $("btnSaveTitles")?.addEventListener("click", ()=>{
    state.titles.edu = $("titleEdu").value.trim() || "EÄŸitim";
    state.titles.exp = $("titleExp").value.trim() || "Deneyim";
    state.titles.cert = $("titleCert").value.trim() || "Sertifikalar";
    state.titles.refs = $("titleRefs").value.trim() || "Referanslar";
    state.titles.essay = $("titleEssay").value.trim() || "Kariyer PlanÄ± / Hedef";
    state.titles.aiComment = $("titleAi").value.trim() || "AI CV Yorumu";
    saveState(); renderAll(); toast("BaÅŸlÄ±klar kaydedildi.");
  });

  $("btnResetTitles")?.addEventListener("click", ()=>{
    state.titles = { edu:"EÄŸitim", exp:"Deneyim", cert:"Sertifikalar", refs:"Referanslar", essay:"Kariyer PlanÄ± / Hedef", aiComment:"AI CV Yorumu" };
    saveState(); renderAll(); toast("BaÅŸlÄ±klar sÄ±fÄ±rlandÄ±.");
  });

  // Show toggles
  const bindToggle = (id, key) => $(id)?.addEventListener("change", (e)=>{ state.show[key]=e.target.checked; saveState(); renderAll(); });
  bindToggle("showEdu","edu"); bindToggle("showExp","exp"); bindToggle("showCert","cert");
  bindToggle("showRefs2","refs"); bindToggle("showEssay2","essay"); bindToggle("showAiComment2","aiComment");
  bindToggle("showCustom","custom");

  $("shareMode")?.addEventListener("change", (e)=>{ state.ui.shareMode=e.target.checked; saveState(); renderAll(); });
  $("redactMode")?.addEventListener("change", (e)=>{ state.ui.redact=e.target.checked; saveState(); renderAll(); });

  // Add custom patch
  $("btnAddCustom")?.addEventListener("click", ()=>{
    const kind = $("customKind").value;
    const title = $("customTitle").value.trim();
    const body = $("customBody").value;
    if (!title && !body){ toast("BaÅŸlÄ±k veya iÃ§erik gir."); return; }
    state.customPatches.push({ id: uid(), kind, title: title || "Ã–zel BÃ¶lÃ¼m", body, visible:true, ts: Date.now() });
    $("customTitle").value=""; $("customBody").value="";
    saveState(); renderAll(); toast("Eklendi.");
  });

  $("btnRunAllJsPatches")?.addEventListener("click", ()=>{
    const jsP = state.customPatches.filter(p=>p.kind==="js" && p.visible!==false);
    let ok=0, fail=0;
    for (const p of jsP){
      try{ (new Function(p.body||""))(); ok++; }catch(e){ console.error(e); fail++; }
    }
    toast(`JS patch: ${ok} Ã§alÄ±ÅŸtÄ±, ${fail} hata.`);
  });

  $("btnClearTrash")?.addEventListener("click", ()=>{
    if (!confirm("Ã‡Ã¶p kutusunu tamamen boÅŸaltmak istiyor musun?")) return;
    clearTrash();
  });
})();

/* Patch existing hard-delete buttons (edu/exp/refs) by swapping their dataset action */
(function rewriteDeleteActs(){
  // Overwrite the existing delegated handler behavior by converting acts to our softDelete calls.
  // We do this by intercepting click early and stopping the original handler for delete actions.
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-act]");
    if (!btn) return;
    const act = btn.dataset.act;
    if (act === "delEdu"){ e.preventDefault(); e.stopImmediatePropagation(); softDelete("edu", Number(btn.dataset.idx)); return; }
    if (act === "delExp"){ e.preventDefault(); e.stopImmediatePropagation(); softDelete("exp", Number(btn.dataset.idx)); return; }
    if (act === "delRef"){ e.preventDefault(); e.stopImmediatePropagation(); softDelete("refs", Number(btn.dataset.idx)); return; }
  }, true);
})();

/* Ensure extensions right away */
ensureExtensions();

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>